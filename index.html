<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 Pro - æé€Ÿæœ¬åœ°è§†é¢‘åˆå¹¶</title>
    <script src="/ffmpeg.min.js"></script>
    <style>
        :root { --primary: #0070f3; --bg: #f5f7fa; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; margin: 0; }
        .card { background: white; padding: 32px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 480px; }
        h2 { margin: 0 0 10px 0; color: #111; font-size: 24px; }
        .status-pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; margin-bottom: 24px; background: #eee; color: #666; }
        .status-ready { background: #e6fffa; color: #059669; }
        .status-error { background: #fff5f5; color: #e53e3e; }
        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
        #log { background: #1a1a1a; color: #32d74b; padding: 16px; height: 160px; overflow-y: auto; margin-top: 24px; border-radius: 8px; font-family: "SF Mono", monospace; font-size: 11px; text-align: left; line-height: 1.6; border: 1px solid #333; }
        .progress-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 20px; display: none; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 è§†é¢‘åŠ©æ‰‹</h2>
        <div id="status" class="status-pill">æ­£åœ¨åˆå§‹åŒ–å†…æ ¸...</div>
        
        <button id="runBtn" class="btn" disabled>é€‰æ‹© M3U8 æ–‡ä»¶å¤¹åˆå¹¶</button>
        
        <div class="progress-container" id="progressWrap">
            <div id="progressBar"></div>
        </div>

        <div id="log">ç­‰å¾…æ“ä½œæ—¥å¿—...</div>

        <div style="margin-top: 20px; color: #999; font-size: 12px;">
            [å•†ä¸šæç¤º] çº¯æµè§ˆå™¨å¤„ç†ï¼Œä¸æ¶ˆè€—æµé‡ï¼Œéšç§å®‰å…¨ã€‚
        </div>
    </div>

    <script>
        // æ£€æµ‹å…¨å±€å˜é‡
        const { FFmpeg } = window.FFmpegWASM || window.FFmpeg || {};
        if (!FFmpeg) {
            document.getElementById('log').innerText = "âŒ é”™è¯¯ï¼šæ— æ³•è¯†åˆ« FFmpeg åº“ã€‚è¯·ç¡®è®¤ ffmpeg.min.js åœ¨æ ¹ç›®å½•ä¸”åŠ è½½æˆåŠŸã€‚";
        }
        
        const ffmpeg = new FFmpeg();
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const statusEl = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressWrap = document.getElementById('progressWrap');

        const addLog = (msg) => {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            logEl.innerText += `\n[${time}] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // åˆå§‹åŒ–å†…æ ¸
        async function init() {
            try {
                const baseURL = window.location.origin;
                addLog("æ­£åœ¨ä»æœ¬åœ°ä»“åº“è½½å…¥æ ¸å¿ƒç»„ä»¶...");
                
                await ffmpeg.load({
                    coreURL: `${baseURL}/ffmpeg-core.js`,
                    wasmURL: `${baseURL}/ffmpeg-core.wasm`,
                    workerURL: `${baseURL}/ffmpeg-core.worker.js`
                });
                
                statusEl.innerText = "â— å†…æ ¸å·²å°±ç»ª";
                statusEl.className = "status-pill status-ready";
                btn.disabled = false;
                addLog("åˆå§‹åŒ–æˆåŠŸï¼å½“å‰æ¨¡å¼ï¼šé«˜æ•ˆç‡å¤šçº¿ç¨‹å¤„ç†ã€‚");
            } catch (e) {
                statusEl.innerText = "â— åˆå§‹åŒ–å¤±è´¥";
                statusEl.className = "status-pill status-error";
                addLog(`é”™è¯¯è¯¦æƒ…: ${e.message}`);
                addLog("è¯·æ£€æŸ¥ï¼š1. æ˜¯å¦ä¸Šä¼ äº† vercel.json 2. æ˜¯å¦ä½¿ç”¨ HTTPS è®¿é—®ã€‚");
                console.error(e);
            }
        }

        // ç›‘å¬ FFmpeg è¾“å‡ºæ—¥å¿—ï¼ˆç”¨äºå•†ä¸šåŒ– UI åé¦ˆï¼‰
        ffmpeg.on('log', ({ message }) => {
            if (message.includes('time=')) {
                // ç®€å•çš„è¿›åº¦æ˜¾ç¤ºé€»è¾‘
                addLog(message); 
            }
        });

        document.getElementById('runBtn').onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                btn.disabled = true;
                progressWrap.style.display = 'block';
                progressBar.style.width = '10%';
                
                addLog(`å·²è·å¾—æˆæƒ: ${handle.name}`);

                // 1. è¯»å–ä¸»æ–‡ä»¶
                const m3u8H = await handle.getFileHandle('index.m3u8');
                const m3u8Data = await (await m3u8H.getFile()).arrayBuffer();
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(m3u8Data));
                addLog("è¯»å– index.m3u8 å®Œæˆ");
                progressBar.style.width = '30%';

                // 2. è½½å…¥åˆ†ç‰‡ (å¯¹åº” index/0.key ç»“æ„)
                await ffmpeg.createDir('index');
                const subDir = await handle.getDirectoryHandle('index');
                addLog("æ­£åœ¨æ‰«æå¹¶è½½å…¥æœ¬åœ°åˆ‡ç‰‡...");
                
                let count = 0;
                for await (const entry of subDir.values()) {
                    if (entry.kind === 'file') {
                        const data = await (await entry.getFile()).arrayBuffer();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(data));
                        count++;
                    }
                }
                addLog(`æˆåŠŸè½½å…¥ ${count} ä¸ªç›¸å…³æ–‡ä»¶ (åŒ…å« .ts å’Œ .key)`);
                progressBar.style.width = '60%';

                // 3. æ‰§è¡Œåˆå¹¶å‘½ä»¤
                addLog("ğŸš€ æ­£åœ¨è§£å¯†åˆå¹¶ä¸­ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");
                await ffmpeg.exec([
                    '-allowed_extensions', 'ALL', // å¿…é¡»å¼€å¯ï¼Œå¦åˆ™æ— æ³•è¯»å– .key
                    '-i', 'index.m3u8',
                    '-c', 'copy',
                    'output.mp4'
                ]);

                // 4. ä¸‹è½½ç»“æœ
                const result = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `M3U8åˆå¹¶_${new Date().getTime()}.mp4`;
                a.click();
                
                progressBar.style.width = '100%';
                addLog("ğŸ‰ åˆå¹¶æˆåŠŸï¼æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚");
                btn.disabled = false;
            } catch (err) {
                addLog(`âŒ å¤±è´¥: ${err.message}`);
                btn.disabled = false;
                progressWrap.style.display = 'none';
            }
        };

        init();
    </script>
</body>
</html>