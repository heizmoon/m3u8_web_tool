<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - å¢å¼ºç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 460px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; word-break: break-all; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; transition: background 0.3s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; display: none; height: 16px; overflow: hidden; position: relative; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.1s; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 16px; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">åˆå§‹åŒ–ç¯å¢ƒ...</div>
        
        <div id="progressContainer" class="progress-container">
            <div id="progressText" class="progress-text">0%</div>
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <button id="runBtn" class="btn" disabled>æ­£åœ¨å‡†å¤‡å†…æ ¸...</button>
        <div id="log">å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨æ£€æŸ¥ç»„ä»¶...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const log = (m) => {
            logEl.innerText += `\n> ${m}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // æ ¸å¿ƒä¸‹è½½å‡½æ•°ï¼šè§£å†³å‹ç¼©ä¼ è¾“å¯¼è‡´çš„è¿›åº¦åå·®
        async function fetchWithProgress(url, name, expectedSize) {
            progressBar.style.width = '0%';
            progressText.innerText = '0%';
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`æ— æ³•è·å– ${name}: ${response.status}`);

            const reader = response.body.getReader();
            // å¦‚æœ Vercel å‹ç¼©äº†ï¼ŒContent-Length å¯èƒ½æ˜¯ 9MBï¼Œä½†è§£å‹åæ˜¯ 31MB
            const contentLength = +response.headers.get('Content-Length') || expectedSize;
            
            let receivedLength = 0;
            let chunks = [];
            
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                chunks.push(value);
                receivedLength += value.length;
                
                // åŠ¨æ€è®¡ç®—è¿›åº¦ï¼Œå–å®é™…æ¥æ”¶å’Œé¢„æœŸå€¼ä¸­è¾ƒå¤§çš„ä¸€ä¸ªä½œä¸ºåˆ†æ¯ï¼Œé˜²æ­¢è¶…è¿‡100%
                const total = Math.max(contentLength, receivedLength);
                let percent = Math.round((receivedLength / total) * 100);
                if (percent > 99) percent = 99; // æ²¡æ”¶å°¾å‰æœ€é«˜æ˜¾ç¤º99%

                progressBar.style.width = percent + '%';
                progressText.innerText = `${percent}% (${(receivedLength/1024/1024).toFixed(1)}MB)`;
                statusEl.innerText = `â³ æ­£åœ¨ä¸‹è½½ ${name}...`;
            }

            // ä¸‹è½½å½»åº•å®Œæˆåæ‰è®¾ä¸º 100%
            progressBar.style.width = '100%';
            progressText.innerText = '100%';
            log(`${name} ä¼ è¾“å®Œæˆï¼Œå®é™…è§£å‹å¤§å°: ${(receivedLength / 1024 / 1024).toFixed(2)} MB`);

            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }
            
            return URL.createObjectURL(new Blob([allChunks.buffer], { 
                type: url.includes('.js') ? 'text/javascript' : 'application/wasm' 
            }));
        }

        async function initSystem() {
            try {
                // 1. åŠ è½½ ffmpeg.min.js
                log("åŠ è½½ FFmpeg å¼•å¯¼è„šæœ¬...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.min.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const FF = window.FFmpegWASM || window.FFmpeg;
                if (!FF) throw new Error("æ— æ³•è¯†åˆ« FFmpeg å¯¹è±¡ï¼Œè¯·æ£€æŸ¥ ffmpeg.min.js æ˜¯å¦æ­£ç¡®ã€‚");

                const ffmpeg = new FF.FFmpeg();
                ffmpeg.on('log', ({ message }) => log(`[FFmpeg] ${message}`));

                progressContainer.style.display = 'block';
                
                // 2. é¢„ä¸‹è½½ 3 ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼ˆå¸¦ä¸Šéšæœºå‚æ•°é˜²æ­¢ç¼“å­˜æ—§çš„æŸåæ–‡ä»¶ï¼‰
                const v = "?t=" + Date.now();
                
                // è¿™é‡Œçš„ expectedSize å‚è€ƒå€¼ï¼šWASM çº¦ 32MB, JS çº¦ 120KB, Worker çº¦ 3KB
                const wasmBlobUrl = await fetchWithProgress('/ffmpeg-core.wasm' + v, 'WASM å†…æ ¸', 32000000);
                const coreBlobUrl = await fetchWithProgress('/ffmpeg-core.js' + v, 'æ ¸å¿ƒè°ƒåº¦å™¨', 120000);
                const workerBlobUrl = await fetchWithProgress('/ffmpeg-core.worker.js' + v, 'å¤šçº¿ç¨‹æ’ä»¶', 3000);

                // 3. å¯åŠ¨å†…æ ¸
                statusEl.innerText = "ğŸš€ æ­£åœ¨æŒ‚è½½å†…æ ¸...";
                log("æ­£åœ¨è°ƒç”¨ ffmpeg.load()...");

                await ffmpeg.load({
                    coreURL: coreBlobUrl,
                    wasmURL: wasmBlobUrl,
                    workerURL: workerBlobUrl
                });

                // 4. å°±ç»ª
                progressContainer.style.display = 'none';
                statusEl.innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
                btn.disabled = false;
                log("åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹åˆå¹¶è§†é¢‘ã€‚");

                // ç‚¹å‡»äº‹ä»¶ä¿æŒä¸å˜
                btn.onclick = async () => {
                    try {
                        const handle = await window.showDirectoryPicker();
                        log("å·²é€‰ä¸­æ–‡ä»¶å¤¹: " + handle.name);
                        // ... æ­¤å¤„æ¥ä½ ä¹‹å‰çš„ä¸šåŠ¡å¤„ç†ä»£ç  ...
                    } catch (e) {
                        log("æ“ä½œå–æ¶ˆ: " + e.message);
                    }
                };

            } catch (err) {
                progressContainer.style.display = 'none';
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                statusEl.style.color = "red";
                log("æ•…éšœåŸå› : " + err.message);
                console.error(err);
            }
        }

        initSystem();
    </script>
</body>
</html>