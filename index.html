<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - æé€Ÿè§£å¯†ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 550px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 250px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; height: 18px; position: relative; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #22c55e; transition: width 0.1s; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 18px; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 æé€Ÿåˆå¹¶ (å¤šçº¿ç¨‹æµå¼ç‰ˆ)</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">ç³»ç»Ÿåˆå§‹åŒ–...</div>
        <div class="progress-container"><div id="progressBar" class="progress-bar"></div><div id="progressText" class="progress-text">å‡†å¤‡å°±ç»ª</div></div>
        <button id="runBtn" class="btn" disabled>æ­£åœ¨å¯åŠ¨å¼•æ“...</button>
        <div id="log">å‡†å¤‡åŠ è½½å¤šçº¿ç¨‹å†…æ ¸...</div>
    </div>

    <script>
        const log = (m) => { const el = document.getElementById('log'); el.innerText += `\n> ${m}`; el.scrollTop = el.scrollHeight; };
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('runBtn');
        let ffmpeg = null;

        async function initSystem() {
            try {
                // åŠ è½½ä¸»è„šæœ¬
                const script = document.createElement('script');
                script.src = '/ffmpeg.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
                ffmpeg = new FFmpeg();

                // æ—¥å¿—åé¦ˆ
                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('Opening')) {
                        const match = message.match(/index\/(.+)/);
                        if (match) statusEl.innerText = "ğŸ”“ æ­£åœ¨è§£å¯†: " + match[1];
                    }
                    log(`[FFmpeg] ${message}`);
                });

                // æ˜¾å¼åŠ è½½å¤šçº¿ç¨‹ worker
                await ffmpeg.load({
                    coreURL: '/ffmpeg-core.js',
                    wasmURL: '/ffmpeg-core.wasm',
                    workerURL: '/ffmpeg-core.worker.js'
                });

                statusEl.innerText = "âœ… ç³»ç»Ÿå°±ç»ª (å¤šçº¿ç¨‹å·²æ¿€æ´»)";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶";
                btn.disabled = false;
                log("åˆå§‹åŒ–æˆåŠŸã€‚è¯·é€‰æ‹©åŒ…å« index.m3u8 å’Œ index æ–‡ä»¶å¤¹çš„ç›®å½•ã€‚");

            } catch (err) {
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                log("é”™è¯¯: " + err.message);
            }
        }

        async function startProcess() {
            try {
                const rootHandle = await window.showDirectoryPicker();
                btn.disabled = true;
                log(`å·²é”å®šç›®å½•: ${rootHandle.name}`);

                try { await ffmpeg.createDir('index'); } catch(e) {}

                let m3u8Content = "";
                
                // ä¼˜åŒ– 1: æ‰¹é‡å¹¶å‘è¯»å–å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œä½†å¢åŠ å†…å­˜é‡Šæ”¾
                for await (const entry of rootHandle.values()) {
                    if (entry.name === 'index.m3u8') {
                        m3u8Content = await (await entry.getFile()).text();
                    } else if (entry.kind === 'directory' && entry.name === 'index') {
                        log("æ­£åœ¨é¢„è½½å…¥ TS ç‰‡æ®µä¸ Key...");
                        const subEntries = [];
                        for await (const se of entry.values()) subEntries.push(se);
                        
                        // åˆ†ç‰‡è½½å…¥ï¼Œé˜²æ­¢ä¸€æ¬¡æ€§å æ»¡ JS å †å†…å­˜
                        for (let i = 0; i < subEntries.length; i++) {
                            const file = await subEntries[i].getFile();
                            const data = new Uint8Array(await file.arrayBuffer());
                            await ffmpeg.writeFile(`index/${subEntries[i].name}`, data);
                            if (i % 200 === 0) statusEl.innerText = `ğŸ“¥ å·²è½½å…¥: ${i}/${subEntries[i].length}`;
                        }
                    }
                }

                // è·¯å¾„é€‚é…
                m3u8Content = m3u8Content.replace(/URI="([^"]+)"/g, (m, p1) => `URI="index/${p1.split('/').pop()}"`);
                await ffmpeg.writeFile('index.m3u8', m3u8Content);

                // ä¼˜åŒ– 2: è°ƒæ•´æŒ‡ä»¤ï¼Œå‡å°‘ç¼“å†²åŒºåˆ†é…
                log("å¼€å§‹æé€Ÿè§£å¯†åˆå¹¶...");
                await ffmpeg.exec([
                    '-allowed_extensions', 'ALL',
                    '-i', 'index.m3u8',
                    '-c', 'copy',
                    '-map_metadata', '-1', // å‡å°‘å…ƒæ•°æ®å¤„ç†è´Ÿæ‹…
                    '-fflags', '+genpts', // é‡æ–°ç”Ÿæˆæ—¶é—´æˆ³é˜²æ­¢æ­»é”
                    'output.mp4'
                ]);

                const result = await ffmpeg.readFile('output.mp4');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                a.download = rootHandle.name + "_ok.mp4";
                a.click();

                statusEl.innerText = "ğŸ‰ å¤„ç†å®Œæˆï¼";
                btn.disabled = false;
            } catch (e) {
                log("ä»»åŠ¡å¤±è´¥: " + e.message);
                btn.disabled = false;
            }
        }

        initSystem();
    </script>
</body>
</html>