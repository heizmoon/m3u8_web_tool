<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - å•†ä¸šçº§å¢å¼ºç‰ˆ</title>
    <style>
        :root { --primary: #0070f3; --success: #22c55e; }
        body { font-family: system-ui, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .main-btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .main-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .secondary-btn { background: #6366f1; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 14px; font-weight: bold; margin-bottom: 15px; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-box { margin: 15px 0; padding: 15px; background: #f0f7ff; border-radius: 10px; }
        .bar-bg { width: 100%; background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; margin: 8px 0; }
        .bar-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .info-panel { background: #fffbeb; border: 1px solid #fef3c7; padding: 15px; border-radius: 10px; font-size: 13px; color: #92400e; margin-bottom: 20px; }
        .ad-slot { background: #f1f5f9; border: 2px dashed #cbd5e1; height: 250px; display: flex; align-items: center; justify-content: center; color: #94a3b8; border-radius: 10px; text-align: center; }
        
        #log { background: #0f172a; color: #38bdf8; padding: 15px; height: 180px; overflow-y: auto; font-size: 11px; border-radius: 8px; font-family: monospace; }
        .stats { display: flex; justify-content: space-around; font-size: 12px; color: #475569; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin:0 0 20px 0;">ğŸ¬ M3U8 Pro è§†é¢‘åˆå¹¶åŠ©æ‰‹</h2>

        <div class="progress-box">
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span id="task-name">å¼•æ“å‡†å¤‡ä¸­...</span>
                <b id="task-pct">0%</b>
            </div>
            <div class="bar-bg"><div id="task-bar" class="bar-fill"></div></div>
            <div id="status-line" class="stats">
                <span>æ—¶é—´: <b id="stat-time">-</b></span>
                <span>ä½“ç§¯: <b id="stat-size">-</b></span>
                <span>é€Ÿåº¦: <b id="stat-speed">-</b></span>
            </div>
        </div>

        <button id="runBtn" class="main-btn" onclick="startProcess()" disabled>æ­£åœ¨åŠ è½½å¼•æ“...</button>
        <button id="mergeMp4Btn" class="secondary-btn" onclick="mergeLocalMp4()">ğŸ§© åˆå¹¶å·²ä¸‹è½½çš„ MP4 åˆ†æ®µ</button>

        <div id="log"></div>
    </div>

    <div class="sidebar">
        <div class="info-panel">
            <h4 style="margin-top:0;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
            <ul style="padding-left:15px;">
                <li><b>é˜²å´©æºƒæœºåˆ¶ï¼š</b>é’ˆå¯¹ 2000+ ç‰‡æ®µï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æ®µå¯¼å‡ºä»¥ä¿æŠ¤æµè§ˆå™¨å†…å­˜ã€‚</li>
                <li><b>ä¸€é”®æ‹¼æ¥ï¼š</b>å¯¼å‡ºå®Œæˆåï¼Œç‚¹å‡»â€œåˆå¹¶å·²ä¸‹è½½çš„ MP4â€å³å¯å°†åˆ†æ®µæ— æŸæ‹¼ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚</li>
                <li><b>ç¯å¢ƒå»ºè®®ï¼š</b>æ¨èä½¿ç”¨ Chrome/Edge æµè§ˆå™¨ï¼Œå¹¶é¢„ç•™ 4GB+ å†…å­˜ã€‚</li>
            </ul>
        </div>

        <div class="ad-slot">
            <div>
                <p>å•†ä¸šåˆä½œä½</p>
                <p style="font-size:10px;">ADVERTISING SPACE</p>
            </div>
        </div>
    </div>
</div>

<script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('runBtn');
    const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
    
    let ffmpeg = null;

    // 1. åˆå§‹åŒ–å¼•æ“ä¸è¿›åº¦æ¡ä¿®æ­£
    async function initSystem() {
        try {
            const script = document.createElement('script');
            script.src = '/ffmpeg.js';
            document.head.appendChild(script);
            await new Promise(r => script.onload = r);

            const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
            ffmpeg = new FFmpeg();

            ffmpeg.on('log', ({ message }) => {
                if (message.includes('frame=')) parseLog(message);
                log(`[å†…æ ¸] ${message}`);
            });

            const wasmURL = await fetchWithProgress('/ffmpeg-core.wasm', 'WASM å†…æ ¸', 32000000);
            const coreURL = await fetchWithProgress('/ffmpeg-core.js', 'è°ƒåº¦è„šæœ¬', 100000);
            const workerURL = await fetchWithProgress('/ffmpeg-core.worker.js', 'å¤šçº¿ç¨‹', 100000);

            await ffmpeg.load({ coreURL, wasmURL, workerURL });
            btn.disabled = false;
            btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
            document.getElementById('task-name').innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ª";
        } catch (e) { log("åˆå§‹åŒ–å¤±è´¥: " + e.message); }
    }

    async function fetchWithProgress(url, name, est) {
        const resp = await fetch(url);
        const reader = resp.body.getReader();
        const total = +resp.headers.get('Content-Length') || est;
        let loaded = 0; let chunks = [];
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.length;
            const pct = Math.min(Math.round((loaded / total) * 100), 99);
            document.getElementById('task-pct').innerText = pct + '%';
            document.getElementById('task-bar').style.width = pct + '%';
            document.getElementById('task-name').innerText = `åŠ è½½ ${name}...`;
        }
        document.getElementById('task-pct').innerText = '100%';
        document.getElementById('task-bar').style.width = '100%';
        return URL.createObjectURL(new Blob(chunks));
    }

    function parseLog(msg) {
        const time = msg.match(/time=\s*([\d:.]+)/)?.[1] || '-';
        const size = msg.match(/size=\s*(\d+)kB/)?.[1] || '0';
        let speed = msg.match(/speed=\s*([\d.e+x\s]+)/)?.[1] || '-';
        if (speed.includes('e+')) speed = Math.round(parseFloat(speed)) + 'x';

        document.getElementById('stat-time').innerText = time;
        document.getElementById('stat-size').innerText = (parseInt(size)/1024).toFixed(1) + ' MB';
        document.getElementById('stat-speed').innerText = speed;
    }

    // 2. ä¸»æµç¨‹ï¼šåˆ†æ®µå¯¼å‡º
    async function startProcess() {
        try {
            const dir = await window.showDirectoryPicker();
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨è§£å¯†åˆå¹¶...";

            try { await ffmpeg.createDir('index'); } catch(e){}

            let m3u8 = ""; let ts = [];
            for await (const e of dir.values()) {
                if (e.name === 'index.m3u8') m3u8 = await (await e.getFile()).text();
                else if (e.name === 'index') {
                    for await (const s of e.values()) {
                        if(s.name.endsWith('.ts')) ts.push(s);
                        if(s.name.endsWith('.key')) await ffmpeg.writeFile(`index/${s.name}`, new Uint8Array(await (await s.getFile()).arrayBuffer()));
                    }
                }
            }
            ts.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));

            const bSize = 1000; // è°ƒæ•´ä¸º 1000 ç‰‡ä¸€ç»„
            const parts = [];
            for (let i = 0; i < ts.length; i += bSize) parts.push(ts.slice(i, i + bSize));

            for (let i = 0; i < parts.length; i++) {
                const name = `Part_${i+1}.mp4`;
                document.getElementById('task-name').innerText = `æ­£åœ¨å¤„ç†åˆ†æ®µ ${i+1}/${parts.length}`;
                
                await processBatch(parts[i], m3u8, name);
                const data = await ffmpeg.readFile(name);
                downloadFile(data, `${dir.name}_${name}`);
                
                // å†…å­˜é‡Šæ”¾ï¼šä¸‹è½½åç«‹å³åˆ é™¤è™šæ‹Ÿæ–‡ä»¶
                await ffmpeg.deleteFile(name);
                for(const f of parts[i]) try { await ffmpeg.deleteFile(`index/${f.name}`); } catch(e){}
            }

            document.getElementById('task-name').innerText = "âœ… åˆ†æ®µå¯¼å‡ºå®Œæˆï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‹¼åˆ";
            btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
            btn.disabled = false;
        } catch (e) { log("å¤±è´¥: " + e.message); btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶"; btn.disabled = false; }
    }

    async function processBatch(list, m3u8, out) {
        for (const f of list) await ffmpeg.writeFile(`index/${f.name}`, new Uint8Array(await (await f.getFile()).arrayBuffer()));
        const set = new Set(list.map(f => f.name));
        const newM = m3u8.split('\n').filter(l => l.includes('.ts') ? set.has(l.trim().split('/').pop()) : true).join('\n')
                      .replace(/URI="([^"]+)"/g, (m, p) => `URI="index/${p.split('/').pop()}"`);
        await ffmpeg.writeFile('t.m3u8', new TextEncoder().encode(newM));
        await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 't.m3u8', '-c', 'copy', '-fflags', '+genpts', out]);
        await ffmpeg.deleteFile('t.m3u8');
    }

    // 3. ğŸ§© æ–°å¢åŠŸèƒ½ï¼šæœ¬åœ°å¤š MP4 åˆå¹¶
    async function mergeLocalMp4() {
    try {
        const files = await window.showOpenFilePicker({ 
            multiple: true, 
            types: [{ description: 'è§†é¢‘åˆ†æ®µ', accept: {'video/mp4': ['.mp4']} }] 
        });
        
        if (files.length < 2) return alert("è¯·è‡³å°‘é€‰æ‹© 2 ä¸ªæ–‡ä»¶");

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šæŒ‰æ–‡ä»¶åä¸­çš„æ•°å­—è‡ªåŠ¨æ’åº ---
        const fileHandles = await Promise.all(files.map(async (h) => {
            const file = await h.getFile();
            return { handle: h, name: file.name, file: file };
        }));

        // è¯†åˆ« Part_1, Part_2 è¿›è¡Œè‡ªç„¶æ’åº
        fileHandles.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
        
        log(`åˆå¹¶é¡ºåºç¡®è®¤: ${fileHandles.map(f => f.name).join(' -> ')}`);

        document.getElementById('task-name').innerText = "ğŸ”— æ­£åœ¨è¿›è¡Œæ— æŸæ‹¼åˆ...";
        let concatList = "";

        for (let i = 0; i < fileHandles.length; i++) {
            const name = `m_${i}.mp4`;
            // å°†æ–‡ä»¶å†™å…¥ WASM è™šæ‹Ÿç³»ç»Ÿ
            await ffmpeg.writeFile(name, new Uint8Array(await fileHandles[i].file.arrayBuffer()));
            concatList += `file '${name}'\n`;
        }

        await ffmpeg.writeFile('list.txt', new TextEncoder().encode(concatList));
        
        // ä½¿ç”¨ -safe 0 ç¡®ä¿è·¯å¾„å®‰å…¨
        await ffmpeg.exec(['-f', 'concat', '-safe', '0', '-i', 'list.txt', '-c', 'copy', 'final.mp4']);
        
        const data = await ffmpeg.readFile('final.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
        const a = document.createElement('a');
        a.href = url;
        a.download = "åˆå¹¶å®Œæˆ_Total.mp4";
        a.click();

        // é‡Šæ”¾å†…å­˜æ¸…ç†
        for(let i=0; i<fileHandles.length; i++) await ffmpeg.deleteFile(`m_${i}.mp4`);
        await ffmpeg.deleteFile('list.txt');
        await ffmpeg.deleteFile('final.mp4');

        document.getElementById('task-name').innerText = "âœ… æœ€ç»ˆè§†é¢‘å·²å¯¼å‡ºï¼";
        btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
    } catch (e) {
        log("åˆå¹¶è¿‡ç¨‹ä¸­æ–­: " + e.message);
        alert("åˆå¹¶å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ–‡ä»¶æ€»å’Œè¶…è¿‡äº† 2GB çš„æµè§ˆå™¨å¯¼å‡ºé™åˆ¶ã€‚å»ºè®®åˆ†ä¸¤æ‰¹åˆå¹¶ï¼Œæˆ–ä½¿ç”¨æœ¬åœ°æ’­æ”¾å™¨ã€‚");
    }
}

    function downloadFile(data, name) {
        const url = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
        const a = document.createElement('a'); a.href = url; a.download = name; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 10000);
    }

    initSystem();
</script>
</body>
</html>