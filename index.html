<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - ç¨³å®šç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 420px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 180px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; word-break: break-all; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; display: none; height: 12px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.2s; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">ç³»ç»Ÿå‡†å¤‡ä¸­...</div>
        
        <div id="progressContainer" class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <button id="runBtn" class="btn" disabled>æ­£åœ¨åˆå§‹åŒ–...</button>
        <div id="log">æ­£åœ¨å¯åŠ¨å¼•æ“...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        const log = (m) => {
            logEl.innerText += `\n> ${m}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // å°è£… fetch ä»¥æ”¯æŒè¿›åº¦æ˜¾ç¤º
        async function fetchWithProgress(url, name) {
            const response = await fetch(url);
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            
            if (!contentLength) log(`è­¦å‘Š: æ— æ³•è·å– ${name} çš„æ–‡ä»¶å¤§å°ï¼Œè¿›åº¦æ¡å°†å¤±æ•ˆ`);

            let receivedLength = 0;
            let chunks = [];
            
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                
                if (contentLength) {
                    const percent = Math.round((receivedLength / contentLength) * 100);
                    progressBar.style.width = percent + '%';
                    statusEl.innerText = `â³ æ­£åœ¨ä¸‹è½½ ${name}: ${percent}%`;
                }
            }

            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }
            
            return URL.createObjectURL(new Blob([allChunks.buffer], { type: url.endsWith('.js') ? 'text/javascript' : 'application/wasm' }));
        }

        async function initSystem() {
            try {
                // 1. åŠ è½½ ffmpeg.min.js
                log("åŠ è½½å¼•å¯¼ç¨‹åº...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.min.js';
                document.head.appendChild(script);
                
                await new Promise((resolve) => script.onload = resolve);

                const FF = window.FFmpegWASM || window.FFmpeg;
                if (!FF) throw new Error("FFmpeg å¯¹è±¡æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ ffmpeg.min.js æ˜¯å¦æ­£ç¡®ç‰ˆæœ¬");

                const ffmpeg = new FF.FFmpeg();
                
                // ç›‘å¬å†…æ ¸æ—¥å¿—
                ffmpeg.on('log', ({ message }) => log(`[FFmpeg] ${message}`));

                // 2. é¢„ä¸‹è½½æ ¸å¿ƒæ–‡ä»¶å¹¶æ˜¾ç¤ºè¿›åº¦
                progressContainer.style.display = 'block';
                
                log("ä¸‹è½½ WASM å†…æ ¸ (çº¦ 30MB)...");
                const wasmBlobUrl = await fetchWithProgress('/ffmpeg-core.wasm', 'å†…æ ¸');
                
                log("ä¸‹è½½æ ¸å¿ƒè°ƒåº¦å™¨...");
                const coreBlobUrl = await fetchWithProgress('/ffmpeg-core.js', 'è°ƒåº¦å™¨');
                
                log("ä¸‹è½½å¹¶è¡Œæ’ä»¶...");
                const workerBlobUrl = await fetchWithProgress('/ffmpeg-core.worker.js', 'å¹¶è¡Œæ’ä»¶');

                // 3. å¯åŠ¨å†…æ ¸
                statusEl.innerText = "ğŸš€ æ­£åœ¨å¯åŠ¨å†…æ ¸...";
                await ffmpeg.load({
                    coreURL: coreBlobUrl,
                    wasmURL: wasmBlobUrl,
                    workerURL: workerBlobUrl
                });

                // 4. å®Œæˆåˆå§‹åŒ–
                progressContainer.style.display = 'none';
                statusEl.innerText = "âœ… ç³»ç»Ÿå°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
                btn.disabled = false;
                log("æ‰€æœ‰ç»„ä»¶åŠ è½½æˆåŠŸï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œã€‚");

                // ç»‘å®šç‚¹å‡»äº‹ä»¶ (æ­¤å¤„ä¿ç•™ä½ åŸæœ‰çš„ M3U8 å¤„ç†é€»è¾‘)
                btn.onclick = async () => {
                    try {
                        const handle = await window.showDirectoryPicker();
                        log("å·²é€‰æ‹©æ–‡ä»¶å¤¹: " + handle.name);
                        // å¤„ç†é€»è¾‘...
                    } catch (e) {
                        log("æ“ä½œå–æ¶ˆæˆ–å¤±è´¥: " + e.message);
                    }
                };

            } catch (err) {
                progressContainer.style.display = 'none';
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                statusEl.style.color = "red";
                log("é”™è¯¯è¯¦æƒ…: " + err.message);
                console.error(err);
            }
        }

        // å¯åŠ¨ç³»ç»Ÿ
        initSystem();
    </script>
</body>
</html>