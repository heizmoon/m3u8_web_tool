<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 500px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 250px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; height: 18px; position: relative; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.1s; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 18px; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">åˆå§‹åŒ–å¼•æ“...</div>
        
        <div id="progressContainer" class="progress-container">
            <div id="progressText" class="progress-text">å‡†å¤‡ä¸­...</div>
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <button id="runBtn" class="btn" disabled>æ­£åœ¨è½½å…¥å¼•æ“...</button>
        <div id="log">æ­£åœ¨ç¡®è®¤æ–‡ä»¶ç»“æ„...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
        let ffmpeg = null;

        // å¼ºåŠ›ä¸‹è½½å‡½æ•°
        async function fetchFile(url, name) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`${name} ä¸‹è½½å¤±è´¥`);
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length') || 32000000;
            let receivedLength = 0, chunks = [];
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                let percent = Math.min(Math.round((receivedLength / Math.max(contentLength, receivedLength)) * 100), 99);
                progressBar.style.width = percent + '%';
                progressText.innerText = `${percent}% (${(receivedLength/1024/1024).toFixed(1)}MB)`;
            }
            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) { allChunks.set(chunk, position); position += chunk.length; }
            return URL.createObjectURL(new Blob([allChunks.buffer]));
        }

        async function initSystem() {
            try {
                // åŠ è½½ ffmpeg.js (å¯¹åº”ä½ ä¿®æ”¹åçš„æ–‡ä»¶å)
                const script = document.createElement('script');
                script.src = '/ffmpeg.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const FF = window.FFmpegWASM || window.FFmpeg;
                ffmpeg = new FF.FFmpeg();
                
                // ç›‘å¬å†…æ ¸æ—¥å¿—
                ffmpeg.on('log', ({ message }) => {
                    if(message.includes('frame=')) {
                        statusEl.innerText = "ğŸš€ æ­£åœ¨ç¼–ç : " + message.split('fps=')[0];
                    } else {
                        log(`[FFmpeg] ${message}`);
                    }
                });

                const v = "?v=" + Date.now();
                const wasmUrl = await fetchFile('/ffmpeg-core.wasm' + v, 'WASM');
                const coreUrl = await fetchFile('/ffmpeg-core.js' + v, 'Core JS');

                await ffmpeg.load({ coreURL: coreUrl, wasmURL: wasmUrl });

                statusEl.innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶è§†é¢‘";
                btn.disabled = false;
                log("åˆå§‹åŒ–æˆåŠŸï¼Œè¯·é€‰æ‹©åŒ…å« TS æ–‡ä»¶çš„æ–‡ä»¶å¤¹ã€‚");

                // ç‚¹å‡»ä¸šåŠ¡é€»è¾‘
                btn.onclick = startProcess;

            } catch (err) {
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                log("é”™è¯¯: " + err.message);
            }
        }

        async function startProcess() {
    try {
        const rootHandle = await window.showDirectoryPicker();
        btn.disabled = true;
        statusEl.innerText = "ğŸ“‚ æ­£åœ¨æ·±åº¦æ‰«æ...";
        log(`å·²æ‰“å¼€æ ¹ç›®å½•: ${rootHandle.name}`);

        // 1. åˆ›å»ºè™šæ‹Ÿç›®å½•ç»“æ„
        try { await ffmpeg.createDir('index'); } catch(e) {} 

        let m3u8Content = "";
        let hasKey = false;

        // 2. éå†å¹¶åˆ†ç±»æ–‡ä»¶
        for await (const entry of rootHandle.values()) {
            if (entry.name === 'index.m3u8') {
                const file = await entry.getFile();
                m3u8Content = await file.text();
                log("è¯»å–åˆ° index.m3u8");
            } 
            else if (entry.kind === 'directory' && entry.name === 'index') {
                log("è¿›å…¥ index å­ç›®å½•è¯»å–æ•°æ®...");
                for await (const subEntry of entry.values()) {
                    const file = await subEntry.getFile();
                    const data = new Uint8Array(await file.arrayBuffer());
                    const virtualPath = `index/${subEntry.name}`;
                    
                    await ffmpeg.writeFile(virtualPath, data);
                    
                    if (subEntry.name.endsWith('.key')) {
                        hasKey = true;
                        log(`å·²è½½å…¥åŠ å¯†å¯†é’¥: ${subEntry.name}`);
                    }
                }
            }
        }

        if (!m3u8Content) throw new Error("æœªæ‰¾åˆ° index.m3u8 æ–‡ä»¶");

        // 3. å…³é”®ï¼šç¡®ä¿ M3U8 å†…éƒ¨çš„ KEY è·¯å¾„æ­£ç¡®
        // è¿™é‡Œçš„é€»è¾‘æ˜¯å°† M3U8 é‡Œçš„è·¯å¾„å¼ºåˆ¶æŒ‡å‘æˆ‘ä»¬è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿé‡Œçš„è·¯å¾„
        if (hasKey) {
            // åŒ¹é… URI="xxx" å¹¶æ›¿æ¢ä¸ºè™šæ‹Ÿè·¯å¾„
            m3u8Content = m3u8Content.replace(/URI="([^"]+)"/g, (match, p1) => {
                const fileName = p1.split('/').pop();
                return `URI="index/${fileName}"`;
            });
            log("M3U8 å¯†é’¥è·¯å¾„å·²ä¿®æ­£ã€‚");
        }
        
        await ffmpeg.writeFile('index.m3u8', m3u8Content);

        // 4. æ‰§è¡Œè§£å¯†åˆå¹¶
        statusEl.innerText = "ğŸ” æ­£åœ¨è§£å¯†å¹¶åˆå¹¶...";
        log("å¼€å§‹æ‰§è¡Œ FFmpeg è§£å¯†æŒ‡ä»¤...");

        // ç›´æ¥è¾“å…¥ m3u8ï¼ŒFFmpeg ä¼šè‡ªåŠ¨æ ¹æ®å†…éƒ¨ç´¢å¼•å» index/ æ‰¾ ts å’Œ key
        await ffmpeg.exec([
            '-allowed_extensions', 'ALL',
            '-i', 'index.m3u8',
            '-c', 'copy',      // è§£å¯†åç›´æ¥å°è£…ï¼Œä¸é‡ç¼–ç 
            '-bsf:a', 'aac_adtstoasc', // ä¿®å¤æŸäº›éŸ³é¢‘åŒæ­¥é—®é¢˜
            'output.mp4'
        ]);

        // 5. å¯¼å‡ºç»“æœ
        log("å¤„ç†å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆä¸‹è½½...");
        const resultData = await ffmpeg.readFile('output.mp4');
        const blob = new Blob([resultData.buffer], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = rootHandle.name + "_decrypted.mp4";
        a.click();

        statusEl.innerText = "ğŸ‰ è§†é¢‘åˆå¹¶å·²å®Œæˆï¼";
        btn.disabled = false;

    } catch (e) {
        log("å¤±è´¥åŸå› : " + e.message);
        console.error(e);
        btn.disabled = false;
    }
}

        initSystem();
    </script>
</body>
</html>