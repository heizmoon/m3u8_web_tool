<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 åˆå¹¶åŠ©æ‰‹ - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 460px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; height: 18px; position: relative; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.1s; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 18px; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
        
        <div id="progressContainer" class="progress-container">
            <div id="progressText" class="progress-text">å‡†å¤‡ä¸‹è½½å†…æ ¸...</div>
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <button id="runBtn" class="btn" disabled>æ­£åœ¨è½½å…¥å¼•æ“...</button>
        <div id="log">æ­£åœ¨ç¡®è®¤æ–‡ä»¶ç»“æ„...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };

        // æ‰‹åŠ¨ä¸‹è½½å¹¶éªŒè¯æ–‡ä»¶
        async function fetchFile(url, name) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`${name} (${url}) ä¸‹è½½å¤±è´¥: ${response.status}`);
            
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length') || 32000000;
            let receivedLength = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                let percent = Math.min(Math.round((receivedLength / Math.max(contentLength, receivedLength)) * 100), 99);
                progressBar.style.width = percent + '%';
                progressText.innerText = `${percent}% (${(receivedLength/1024/1024).toFixed(1)}MB)`;
            }
            
            progressBar.style.width = '100%';
            progressText.innerText = '100%';
            log(`${name} å·²æˆåŠŸæ‹‰å–åˆ°å†…å­˜ (${(receivedLength/1024/1024).toFixed(2)} MB)`);
            
            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }
            return URL.createObjectURL(new Blob([allChunks.buffer], { 
                type: url.includes('.js') ? 'text/javascript' : 'application/wasm' 
            }));
        }

        async function initSystem() {
            try {
                log("1. åŠ è½½ä¸»å…¥å£ ffmpeg.js...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.js'; // å·²æ”¹ä¸ºä½ é‡å‘½åçš„åå­—
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const FF = window.FFmpegWASM || window.FFmpeg;
                if (!FF) throw new Error("æ— æ³•è·å– FFmpeg å¯¹è±¡ï¼Œè¯·æ£€æŸ¥ ffmpeg.js æ˜¯å¦å®Œæ•´ã€‚");

                const ffmpeg = new FF.FFmpeg();
                ffmpeg.on('log', ({ message }) => log(`[å†…æ ¸] ${message}`));

                // 2. ä¾æ¬¡æ‹‰å–å†…æ ¸æ–‡ä»¶
                const v = "?v=" + Date.now();
                
                log("2. æ­£åœ¨æ‹‰å– WASM å†…æ ¸...");
                const wasmUrl = await fetchFile('/ffmpeg-core.wasm' + v, 'WASM');
                
                log("3. æ­£åœ¨æ‹‰å– è°ƒåº¦è„šæœ¬...");
                const coreUrl = await fetchFile('/ffmpeg-core.js' + v, 'Core JS');

                statusEl.innerText = "ğŸš€ æ­£åœ¨æŒ‚è½½å¹¶å¯åŠ¨å†…æ ¸...";
                log("4. æ­£åœ¨æ‰§è¡Œæœ€åä¸€æ­¥ ffmpeg.load()...");

                // æ­¤æ—¶æ‰€æœ‰æ–‡ä»¶å·²åœ¨å†…å­˜ï¼Œload åº”è¯¥ç¬é—´å®Œæˆ
                await ffmpeg.load({
                    coreURL: coreUrl,
                    wasmURL: wasmUrl
                });

                statusEl.innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶è§†é¢‘";
                btn.disabled = false;
                log("5. åˆå§‹åŒ–æˆåŠŸï¼ä¸€åˆ‡å‡†å¤‡å°±ç»ªã€‚");

                btn.onclick = async () => {
                    const handle = await window.showDirectoryPicker();
                    log("å·²æ‰“å¼€ç›®å½•: " + handle.name);
                };

            } catch (err) {
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                log("é”™è¯¯è¯¦æƒ…: " + err.message);
                console.error(err);
            }
        }

        initSystem();
    </script>
</body>
</html>