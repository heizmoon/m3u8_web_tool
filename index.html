document.getElementById('startBtn').onclick = async () => {
    try {
        const handle = await window.showDirectoryPicker();
        log("å·²æˆæƒæ–‡ä»¶å¤¹: " + handle.name);
        
        // 1. è½½å…¥ä¸»ç´¢å¼•
        const m3u8Handle = await handle.getFileHandle('index.m3u8');
        const m3u8Data = await (await m3u8Handle.getFile()).arrayBuffer();
        await ffmpeg.writeFile('index.m3u8', new Uint8Array(m3u8Data));

        // 2. å¤„ç†å­ç›®å½• index
        await ffmpeg.createDir('index');
        const indexDir = await handle.getDirectoryHandle('index');
        
        log("æ­£åœ¨è¯»å–åˆ†ç‰‡æ–‡ä»¶...");
        for await (const entry of indexDir.values()) {
            if (entry.kind === 'file') {
                const file = await entry.getFile();
                const data = await file.arrayBuffer();
                await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(data));
            }
        }

        log("ğŸš€ å¼€å§‹æ‰§è¡Œåˆå¹¶æŒ‡ä»¤ (ä¸è¦å…³é—­çª—å£)...");
        // -allowed_extensions ALL æ˜¯ä¸ºäº†å…è®¸åŠ è½½ .key æ–‡ä»¶
        await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 'index.m3u8', '-c', 'copy', 'output.mp4']);

        const result = await ffmpeg.readFile('output.mp4');
        const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${handle.name}_merged.mp4`;
        a.click();
        log("ğŸ‰ å®Œæˆï¼è¯·æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶ã€‚");

    } catch (err) {
        log("âŒ æ“ä½œå¤±è´¥: " + err.message);
    }
};