<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - å•†ä¸šåŠ é€Ÿç‰ˆ</title>
    <style>
        :root { --primary: #0070f3; --success: #22c55e; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 850px; margin: 0 auto; display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        #status-card { margin-top: 15px; display: none; }
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: monospace; }
        .stat-item { font-size: 13px; color: #64748b; }
        .stat-item b { color: #0f172a; font-size: 14px; }
        #log { background: #0f172a; color: #38bdf8; padding: 15px; height: 220px; overflow-y: auto; font-size: 11px; border-radius: 8px; margin-top: 15px; font-family: 'Fira Code', monospace; }
        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .ad-placeholder { background: #f1f5f9; border: 2px dashed #cbd5e1; height: 300px; display: flex; align-items: center; justify-content: center; color: #94a3b8; border-radius: 8px; margin-top: 20px; }
        .info-panel { background: #fffbeb; border: 1px solid #fef3c7; padding: 15px; border-radius: 8px; font-size: 13px; color: #92400e; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin-top:0">ğŸ¬ M3U8 æé€Ÿåˆå¹¶ Pro</h2>
        
        <div id="init-ui" style="margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span id="init-task">å‡†å¤‡å¼•æ“ä¸­...</span>
                <b id="init-pct">0%</b>
            </div>
            <div style="width:100%; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                <div id="init-bar" style="width:0%; height:100%; background:var(--primary); transition:0.3s;"></div>
            </div>
        </div>

        <button id="runBtn" class="btn" onclick="startProcess()" disabled>å¼•æ“è½½å…¥ä¸­...</button>

        <div id="status-card">
            <div style="margin-bottom:10px; font-weight:bold; color:var(--primary)" id="main-msg">å‡†å¤‡å¤„ç†...</div>
            <div class="grid-stats">
                <div class="stat-item">æ—¶é•¿: <b id="stat-time">00:00:00</b></div>
                <div class="stat-item">ä½“ç§¯: <b id="stat-size">0 MB</b></div>
                <div class="stat-item">é€Ÿåº¦: <b id="stat-speed">0x</b></div>
                <div class="stat-item">å¸§æ•°: <b id="stat-frame">0</b></div>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <div class="sidebar">
        <div class="info-panel">
            <b>ğŸ“Œ åˆå¹¶é¡»çŸ¥</b>
            <p>1. æœ¬æ¬¡åˆå¹¶ç‰‡æ®µè¾ƒå¤š(2859ä¸ª)ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†ä¸‰æ®µå¤„ç†ä»¥é˜²å´©æºƒã€‚</p>
            <p>2. è¯·ç¡®ä¿ç”µè„‘å‰©ä½™ç‰©ç†å†…å­˜ > 4GBã€‚</p>
            <p>3. åˆå¹¶æœŸé—´è¯·å‹¿æœ€å°åŒ–æˆ–åˆ‡æ¢æµè§ˆå™¨æ ‡ç­¾ã€‚</p>
        </div>
        
        <div class="ad-placeholder">å¹¿å‘ŠæŠ•æ”¾ä½</div>
    </div>
</div>

<script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('runBtn');
    const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
    
    let ffmpeg = null;

    // 1. åˆå§‹åŒ–å¼•æ“ï¼ˆå¸¦ç²¾å‡†è¿›åº¦ï¼‰
    async function initSystem() {
        try {
            const script = document.createElement('script');
            script.src = '/ffmpeg.js';
            document.head.appendChild(script);
            await new Promise(r => script.onload = r);

            const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
            ffmpeg = new FFmpeg();

            // ç›‘å¬æ—¥å¿—å¹¶æ›´æ–° UI
            ffmpeg.on('log', ({ message }) => {
                if (message.includes('frame=')) {
                    parseFFmpegLog(message);
                }
                log(`[å†…æ ¸] ${message}`);
            });

            // æ¨¡æ‹Ÿè¿›åº¦åŠ è½½ (WASM çº¦ 37MB)
            const wasmURL = await fetchWithProgress('/ffmpeg-core.wasm', 'æ ¸å¿ƒå†…æ ¸');
            const coreURL = await fetchWithProgress('/ffmpeg-core.js', 'è°ƒåº¦å™¨');
            const workerURL = await fetchWithProgress('/ffmpeg-core.worker.js', 'å¤šçº¿ç¨‹');

            await ffmpeg.load({ coreURL, wasmURL, workerURL });

            document.getElementById('init-task').innerText = "âœ… å¼•æ“å°±ç»ª (å¤šçº¿ç¨‹å·²æ¿€æ´»)";
            document.getElementById('init-bar').style.background = "var(--success)";
            btn.disabled = false;
            btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶";
        } catch (e) {
            log("åˆå§‹åŒ–å¤±è´¥: " + e.message);
        }
    }

    // 2. è¾…åŠ©ï¼šå¸¦è¿›åº¦çš„ä¸‹è½½
    async function fetchWithProgress(url, name) {
        const resp = await fetch(url);
        const reader = resp.body.getReader();
        const total = +resp.headers.get('Content-Length') || 38000000;
        let loaded = 0;
        let chunks = [];
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.length;
            const pct = Math.round((loaded / total) * 100);
            document.getElementById('init-task').innerText = `è½½å…¥ ${name}...`;
            document.getElementById('init-pct').innerText = pct + '%';
            document.getElementById('init-bar').style.width = pct + '%';
        }
        return URL.createObjectURL(new Blob(chunks));
    }

    // 3. æ ¸å¿ƒï¼šè§£ææ—¥å¿—è§£å†³ 1e+03x ç§‘å­¦è®¡æ•°æ³•
    function parseFFmpegLog(msg) {
        document.getElementById('status-card').style.display = 'block';
        const time = msg.match(/time=\s*([\d:.]+)/)?.[1] || '00:00:00';
        const size = msg.match(/size=\s*(\d+)kB/)?.[1] || '0';
        const frame = msg.match(/frame=\s*(\d+)/)?.[1] || '0';
        let speed = msg.match(/speed=\s*([\d.e+x]+)/)?.[1] || '0x';

        if (speed.includes('e+')) {
            speed = Math.round(parseFloat(speed)) + 'x';
        }

        const mb = (parseInt(size) / 1024).toFixed(1);
        document.getElementById('stat-time').innerText = time;
        document.getElementById('stat-size').innerText = mb > 1000 ? (mb/1024).toFixed(2)+' GB' : mb+' MB';
        document.getElementById('stat-speed').innerText = speed;
        document.getElementById('stat-frame').innerText = frame;
    }

    // 4. ä¸šåŠ¡é€»è¾‘ï¼šåˆ†æ®µå¤„ç† 2859 ä¸ªæ–‡ä»¶
    async function startProcess() {
        try {
            const dirHandle = await window.showDirectoryPicker();
            btn.disabled = true;
            log(`å·²é”å®šç›®å½•: ${dirHandle.name}`);

            try { await ffmpeg.createDir('index'); } catch(e) {}

            let m3u8Content = "";
            let tsFiles = [];

            // æ‰«æ
            for await (const entry of dirHandle.values()) {
                if (entry.name === 'index.m3u8') {
                    m3u8Content = await (await entry.getFile()).text();
                } else if (entry.name === 'index' && entry.kind === 'directory') {
                    for await (const sub of entry.values()) {
                        if(sub.name.endsWith('.ts')) tsFiles.push(sub);
                        if(sub.name.endsWith('.key')) {
                            const kData = new Uint8Array(await (await sub.getFile()).arrayBuffer());
                            await ffmpeg.writeFile(`index/${sub.name}`, kData);
                        }
                    }
                }
            }

            tsFiles.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));

            // åˆ†æ®µé€»è¾‘ï¼š1000ä¸ªä¸€ç»„
            const batchSize = 1000;
            const parts = [];
            for (let i = 0; i < tsFiles.length; i += batchSize) {
                parts.push(tsFiles.slice(i, i + batchSize));
            }

            const partFiles = [];
            for (let i = 0; i < parts.length; i++) {
                const partName = `p${i}.mp4`;
                document.getElementById('main-msg').innerText = `ğŸ›  æ­£åœ¨å¤„ç†ç¬¬ ${i+1}/${parts.length} éƒ¨åˆ†...`;
                
                await processBatch(parts[i], m3u8Content, partName);
                partFiles.push(partName);

                // ç«‹å³é‡Šæ”¾æœ¬æ®µå†…å­˜
                log(`æ¸…ç†ç¬¬ ${i+1} æ®µç¼“å­˜...`);
                for(const f of parts[i]) {
                    try { await ffmpeg.deleteFile(`index/${f.name}`); } catch(e) {}
                }
            }

            // æœ€ç»ˆåˆå¹¶
            document.getElementById('main-msg').innerText = "ğŸ”— æ­£åœ¨æ‹¼åˆå„åˆ†æ®µ...";
            const concatTxt = partFiles.map(f => `file '${f}'`).join('\n');
            await ffmpeg.writeFile('concat.txt', new TextEncoder().encode(concatTxt));
            await ffmpeg.exec(['-f', 'concat', '-safe', '0', '-i', 'concat.txt', '-c', 'copy', 'final.mp4']);

            const data = await ffmpeg.readFile('final.mp4');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            a.download = dirHandle.name + ".mp4";
            a.click();

            document.getElementById('main-msg').innerText = "ğŸ‰ æ­å–œï¼åˆå¹¶åœ†æ»¡å®Œæˆ";
            btn.disabled = false;

        } catch (e) {
            log("é”™è¯¯: " + e.message);
            btn.disabled = false;
        }
    }

    // 5. æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šå¤„ç†å•ä¸ª Batch
    async function processBatch(fileList, m3u8, outName) {
        // è½½å…¥
        for (let i = 0; i < fileList.length; i++) {
            const data = new Uint8Array(await (await fileList[i].getFile()).arrayBuffer());
            await ffmpeg.writeFile(`index/${fileList[i].name}`, data);
        }

        // ä¿®æ”¹ M3U8
        const tsSet = new Set(fileList.map(f => f.name));
        let newM3u8 = m3u8.split('\n').filter(line => {
            if(line.includes('.ts')) {
                return tsSet.has(line.trim().split('/').pop());
            }
            return true;
        }).join('\n').replace(/URI="([^"]+)"/g, (m, p1) => `URI="index/${p1.split('/').pop()}"`);

        await ffmpeg.writeFile('tmp.m3u8', new TextEncoder().encode(newM3u8));
        await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 'tmp.m3u8', '-c', 'copy', '-fflags', '+genpts', outName]);
        await ffmpeg.deleteFile('tmp.m3u8');
    }

    initSystem();
</script>

</body>
</html>