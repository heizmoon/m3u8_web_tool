<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 æé€Ÿåˆå¹¶ - ç¦»çº¿å•†ç”¨ç‰ˆ</title>
    <script src="ffmpeg.min.js"></script>
    <style>
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 500px; text-align: center; }
        h2 { color: #1a1a1b; margin-bottom: 8px; }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 20px; background: #eee; color: #666; }
        .btn { background: #007aff; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s; width: 100%; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #log { background: #1e1e1e; color: #32d74b; padding: 15px; height: 180px; overflow-y: auto; margin-top: 25px; border-radius: 8px; font-family: "SF Mono", monospace; font-size: 11px; text-align: left; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 å·¥å…·ç®±</h2>
        <div id="status" class="status-tag">æ­£åœ¨åˆå§‹åŒ–å†…æ ¸...</div>
        
        <button id="runBtn" class="btn" disabled>é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¼€å§‹</button>
        
        <div id="log">ç­‰å¾…æ“ä½œæ—¥å¿—...</div>
    </div>

    <script>
        // ä» FFmpegWASM å¯¹è±¡ä¸­æå– FFmpeg ç±»
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();

        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const statusEl = document.getElementById('status');

        const addLog = (msg) => {
            logEl.innerText += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘
        async function init() {
            try {
                // æ˜¾å¼æŒ‡å®šæœ¬åœ°è·¯å¾„ï¼Œè§£å†³ 404 å’Œæ‹¦æˆªé—®é¢˜
                const baseURL = window.location.origin;
                await ffmpeg.load({
                    coreURL: `${baseURL}/ffmpeg-core.js`,
                    wasmURL: `${baseURL}/ffmpeg-core.wasm`,
                    workerURL: `${baseURL}/ffmpeg-core.worker.js`
                });
                
                statusEl.innerText = "â— å†…æ ¸å·²å°±ç»ª";
                statusEl.style.background = "#e3f9eb";
                statusEl.style.color = "#28a745";
                btn.disabled = false;
                addLog("FFmpeg å†…æ ¸å·²ä»æœ¬åœ°ä»“åº“æˆåŠŸåŠ è½½ã€‚");
            } catch (e) {
                statusEl.innerText = "â— åˆå§‹åŒ–å¤±è´¥";
                statusEl.style.background = "#fff2f0";
                statusEl.style.color = "#ff4d4f";
                addLog("å¤±è´¥åŸå› : æµè§ˆå™¨å¯èƒ½ç¦ç”¨äº† WebAssembly æˆ–è·¨åŸŸéš”ç¦»ã€‚");
                console.error(e);
            }
        }

        document.getElementById('runBtn').onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                btn.disabled = true;
                addLog(`æ­£åœ¨è®¿é—®æ–‡ä»¶å¤¹: ${handle.name}`);

                // 1. è¯»å–ä¸» index.m3u8 å¹¶å†™å…¥å†…å­˜
                const m3u8File = await (await handle.getFileHandle('index.m3u8')).getFile();
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(await m3u8File.arrayBuffer()));
                addLog("è½½å…¥ index.m3u8 æˆåŠŸ");

                // 2. å¤„ç† index æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ ts/key æ–‡ä»¶
                await ffmpeg.createDir('index');
                const subDir = await handle.getDirectoryHandle('index');
                addLog("æ­£åœ¨æ‰«æ index ç›®å½•...");
                
                for await (const entry of subDir.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        const data = await file.arrayBuffer();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(data));
                    }
                }
                addLog("è§†é¢‘åˆ†ç‰‡è½½å…¥å®Œæ¯•ï¼Œå¼€å§‹åˆå¹¶...");

                // 3. æ‰§è¡Œåˆå¹¶å‘½ä»¤ (å¯¹åº” image_3db59a.png ä¸­çš„è·¯å¾„é…ç½®)
                await ffmpeg.exec([
                    '-allowed_extensions', 'ALL',
                    '-i', 'index.m3u8',
                    '-c', 'copy', 'output.mp4'
                ]);

                // 4. ç”Ÿæˆä¸‹è½½
                const result = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${handle.name}_merged.mp4`;
                a.click();
                
                addLog("ğŸ‰ åˆå¹¶æˆåŠŸï¼è§†é¢‘å·²è‡ªåŠ¨å¼€å§‹ä¸‹è½½ã€‚");
                btn.disabled = false;
            } catch (err) {
                addLog(`âŒ å‡ºé”™äº†: ${err.message}`);
                btn.disabled = false;
            }
        };

        init();
    </script>
</body>
</html>