<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 æé€Ÿåˆå¹¶ - å•†ä¸šæ­£å¼ç‰ˆ</title>
    <script src="./ffmpeg.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        .status-box { padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; }
        .loading { background: #fff7e6; color: #faad14; }
        .ready { background: #f6ffed; color: #52c41a; }
        .error { background: #fff1f0; color: #f5222d; }
        .btn { background: #1890ff; color: white; border: none; padding: 14px 28px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn:disabled { background: #d9d9d9; cursor: not-allowed; }
        #log { background: #001529; color: #d6e4ff; padding: 15px; height: 180px; overflow-y: auto; margin-top: 20px; border-radius: 4px; font-family: monospace; font-size: 11px; text-align: left; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 åˆå¹¶å·¥å…·</h2>
        <div id="status" class="status-box loading">æ­£åœ¨åˆå§‹åŒ–å†…æ ¸...</div>
        <button id="startBtn" class="btn" disabled>é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹</button>
        <div id="log">å‡†å¤‡å°±ç»ªï¼Œè¯·ç­‰å¾…å†…æ ¸åŠ è½½ã€‚</div>
    </div>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();

        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');

        const addLog = (m) => {
            logEl.innerText += `\n> ${m}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        async function init() {
            try {
                // å…³é”®ç‚¹ï¼šæ˜¾å¼å®šä½æ‰€æœ‰æœ¬åœ°æ–‡ä»¶
                const baseURL = window.location.origin;
                await ffmpeg.load({
                    coreURL: `${baseURL}/ffmpeg-core.js`,
                    wasmURL: `${baseURL}/ffmpeg-core.wasm`,
                    workerURL: `${baseURL}/ffmpeg-core.worker.js`
                });

                statusEl.className = 'status-box ready';
                statusEl.innerText = 'âœ… å†…æ ¸å°±ç»ª (ç¦»çº¿æ¨¡å¼)';
                startBtn.disabled = false;
                addLog("FFmpeg æ ¸å¿ƒåŠ è½½æˆåŠŸï¼å¯ä»¥å¼€å§‹æ“ä½œã€‚");
            } catch (e) {
                statusEl.className = 'status-box error';
                statusEl.innerText = 'âŒ åŠ è½½å¤±è´¥';
                addLog("å¤±è´¥ï¼è¯·æ£€æŸ¥ï¼š1. æ˜¯å¦æœ‰ vercel.json 2. æµè§ˆå™¨æ˜¯å¦æ”¯æŒ SharedArrayBuffer 3. æ–‡ä»¶æ˜¯å¦å…¨åœ¨ä»“åº“æ ¹ç›®å½•ã€‚");
                console.error(e);
            }
        }

        startBtn.onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                startBtn.disabled = true;
                addLog(`å·²è·å¾—æ–‡ä»¶å¤¹: ${handle.name}`);

                // å†™å…¥ index.m3u8
                const m3u8H = await handle.getFileHandle('index.m3u8');
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(await (await m3u8H.getFile()).arrayBuffer()));

                // å¤„ç†å­æ–‡ä»¶å¤¹ index
                await ffmpeg.createDir('index');
                const idxDir = await handle.getDirectoryHandle('index');
                for await (const entry of idxDir.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(await file.arrayBuffer()));
                        addLog(`è½½å…¥: ${entry.name}`);
                    }
                }

                addLog("ğŸš€ å¼€å§‹åˆå¹¶ï¼Œè¯·å‹¿å…³é—­é¡µé¢...");
                // è¿›åº¦ç›‘å¬
                ffmpeg.on('log', ({ message }) => { if(message.includes('frame=')) addLog(message); });

                await ffmpeg.exec(['-i', 'index.m3u8', '-c', 'copy', 'final.mp4']);

                const data = await ffmpeg.readFile('final.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = "åˆå¹¶å®Œæˆ.mp4";
                a.click();
                addLog("ğŸ‰ å®Œæˆï¼å·²è§¦å‘ä¸‹è½½ã€‚");
            } catch (err) {
                addLog("é”™è¯¯: " + err.message);
            } finally {
                startBtn.disabled = false;
            }
        };

        init();
    </script>
</body>
</html>