<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - æœ€ç»ˆå…¼å®¹ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 460px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">æ­£åœ¨å¯åŠ¨ç³»ç»Ÿ...</div>
        <button id="runBtn" class="btn" disabled>å†…æ ¸åˆå§‹åŒ–ä¸­...</button>
        <div id="log">æ­£åœ¨è¿æ¥ Vercel è¾¹ç¼˜èŠ‚ç‚¹...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };

        async function initSystem() {
            try {
                log("1. æŒ‚è½½ FFmpeg è„šæœ¬...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
                const ffmpeg = new FFmpeg();

                // ç›‘å¬è¯¦ç»†æ—¥å¿—
                ffmpeg.on('log', ({ message }) => log(`[å†…æ ¸è¾“å‡º] ${message}`));

                statusEl.innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½å¹¶åˆå§‹åŒ–å†…æ ¸...";
                log("2. æ‰§è¡Œ ffmpeg.load()...");
                log("æ³¨æ„ï¼šå¦‚æœæ­¤æ­¥å¡ä½ï¼Œè¯·æ£€æŸ¥ Console æ§åˆ¶å°æŠ¥é”™ã€‚");

                // ä½¿ç”¨å¸¦æœ‰æ—¶é—´æˆ³çš„ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿ä¸ä½¿ç”¨æ—§ç¼“å­˜ä¸”ç›´æ¥è¯·æ±‚
                const baseURL = window.location.origin;
                const v = "?v=" + Date.now();

                await ffmpeg.load({
                    coreURL: baseURL + '/ffmpeg-core.js' + v,
                    wasmURL: baseURL + '/ffmpeg-core.wasm' + v
                });

                statusEl.innerText = "âœ… åˆå§‹åŒ–åœ†æ»¡æˆåŠŸ";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶";
                btn.disabled = false;
                log("3. ç¯å¢ƒå·²å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©æ–‡ä»¶å¤¹ã€‚");

                btn.onclick = async () => {
                    try {
                        const handle = await window.showDirectoryPicker();
                        log("é€‰ä¸­ç›®å½•: " + handle.name);
                    } catch (e) { log("æ“ä½œå–æ¶ˆ"); }
                };

            } catch (err) {
                statusEl.innerText = "âŒ åˆå§‹åŒ–å¤±è´¥";
                log("å¼‚å¸¸è¯¦æƒ…: " + err.message);
                console.error("FFmpeg Load Error:", err);
            }
        }

        // æ‰§è¡Œåˆå§‹åŒ–
        initSystem();
    </script>
</body>
</html>