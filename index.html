<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 æé€Ÿåˆå¹¶ - å•†ä¸šæ¼”ç¤ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/index.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; display: flex; justify-content: center; padding: 50px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        .btn { background: #0070f3; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 16px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        #log { background: #000; color: #00ff00; padding: 15px; height: 150px; overflow-y: auto; margin-top: 20px; font-family: monospace; font-size: 12px; text-align: left; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 åˆå¹¶å™¨</h2>
        <p style="font-size:14px; color:#666;">æœ¬åœ°è§£å¯†åˆå¹¶ï¼Œä¸æ¶ˆè€—æœåŠ¡å™¨æµé‡</p>
        <button id="startBtn" class="btn">é€‰æ‹©æ–‡ä»¶å¤¹å¹¶å¼€å§‹</button>
        <div id="log">æ­£åœ¨åˆå§‹åŒ–å†…æ ¸...</div>
        <div id="downloadArea" style="margin-top:20px; display:none;">
            <a id="dlLink" href="#" style="color:#0070f3; font-weight:bold;">âœ… åˆå¹¶æˆåŠŸï¼ç‚¹å‡»ä¸‹è½½è§†é¢‘</a>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨è¯†åˆ«åº“å˜é‡
        const FF = window.FFmpegWASM || window.FFmpeg;
        if (!FF) {
            document.getElementById('log').innerText = "âŒ è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å…³é—­æµè§ˆå™¨è·Ÿè¸ªä¿æŠ¤ã€‚";
        }

        const ffmpeg = new FF.FFmpeg();
        const logEl = document.getElementById('log');
        const btn = document.getElementById('startBtn');

        function addLog(m) {
            logEl.innerText += `\n> ${m}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function init() {
            try {
                // åŠ è½½å†…æ ¸
                await ffmpeg.load({
                    coreURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js',
                });
                addLog("å†…æ ¸åŠ è½½æˆåŠŸï¼Œå‡†å¤‡å°±ç»ªï¼");
            } catch (e) {
                addLog("åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ Vercel å·²é…ç½® vercel.json å¼€å¯éš”ç¦»æ¨¡å¼ã€‚");
            }
        }

        btn.onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                btn.disabled = true;
                addLog(`å·²è·å¾—æˆæƒ: ${handle.name}`);

                // è¯»å– index.m3u8 (å¯¹åº” image_3db847.png ç»“æ„)
                const m3u8File = await (await handle.getFileHandle('index.m3u8')).getFile();
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(await m3u8File.arrayBuffer()));
                
                // å¤„ç† index æ–‡ä»¶å¤¹
                await ffmpeg.createDir('index');
                const indexDir = await handle.getDirectoryHandle('index');
                for await (const entry of indexDir.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(await file.arrayBuffer()));
                    }
                }

                addLog("å¼€å§‹åˆå¹¶ (è¿™å¯èƒ½éœ€è¦ 1-3 åˆ†é’Ÿ)...");
                // æ‰§è¡Œ ffmpeg å‘½ä»¤ (å¯¹åº” image_3db59a.png è·¯å¾„)
                await ffmpeg.exec(['-i', 'index.m3u8', '-c', 'copy', 'out.mp4']);
                
                const data = await ffmpeg.readFile('out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
                
                document.getElementById('dlLink').href = url;
                document.getElementById('dlLink').download = "merged_video.mp4";
                document.getElementById('downloadArea').style.display = 'block';
                addLog("åˆå¹¶å®Œæˆï¼");
            } catch (e) {
                addLog("å‡ºé”™äº†: " + e.message);
                btn.disabled = false;
            }
        };

        init();
    </script>
</body>
</html>