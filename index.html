<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - ç¨³å®šç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 420px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 180px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; display: none; height: 12px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.1s; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">ç³»ç»Ÿå‡†å¤‡ä¸­...</div>
        <div id="progressContainer" class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <button id="runBtn" class="btn" disabled>æ­£åœ¨åˆå§‹åŒ–...</button>
        <div id="log">æ­£åœ¨å¯åŠ¨å¼•æ“...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        const log = (m) => {
            logEl.innerText += `\n> ${m}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // ä¿®æ­£åçš„ä¸‹è½½å‡½æ•°
        async function fetchWithProgress(url, name) {
            // æ¯æ¬¡ä¸‹è½½æ–°æ–‡ä»¶å‰é‡ç½®è¿›åº¦æ¡
            progressBar.style.width = '0%';
            const response = await fetch(url);
            
            // æ£€æŸ¥å“åº”
            if (!response.ok) throw new Error(`æ— æ³•è·å–æ–‡ä»¶: ${url} (çŠ¶æ€ç : ${response.status})`);

            const reader = response.body.getReader();
            // æ³¨æ„ï¼šå¦‚æœæœåŠ¡å™¨å¯ç”¨äº† Gzipï¼Œè¿™é‡Œçš„ contentLength å¯èƒ½ä¸å‡†ç¡®
            const contentLength = +response.headers.get('Content-Length') || 0;
            
            let receivedLength = 0;
            let chunks = [];
            
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                
                if (contentLength > 0) {
                    let percent = Math.round((receivedLength / contentLength) * 100);
                    // é˜²æ­¢ç™¾åˆ†æ¯”æº¢å‡ºæ˜¾ç¤º
                    if (percent > 100) percent = 100; 
                    progressBar.style.width = percent + '%';
                    statusEl.innerText = `â³ æ­£åœ¨ä¸‹è½½ ${name}: ${percent}%`;
                } else {
                    statusEl.innerText = `â³ æ­£åœ¨ä¸‹è½½ ${name}: ${(receivedLength / 1024 / 1024).toFixed(2)}MB`;
                }
            }

            log(`${name} ä¸‹è½½å®Œæˆï¼Œå®é™…å¤§å°: ${(receivedLength / 1024 / 1024).toFixed(2)} MB`);
            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }
            
            return URL.createObjectURL(new Blob([allChunks.buffer], { 
                type: url.endsWith('.js') ? 'text/javascript' : 'application/wasm' 
            }));
        }

        async function initSystem() {
            try {
                // 1. åŠ è½½ä¸»è„šæœ¬
                const script = document.createElement('script');
                script.src = '/ffmpeg.min.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const FF = window.FFmpegWASM || window.FFmpeg;
                const ffmpeg = new FF.FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('Error')) log(`[å†…æ ¸é”™è¯¯] ${message}`);
                });

                progressContainer.style.display = 'block';
                
                // 2. ä¾æ¬¡åŠ è½½æ ¸å¿ƒæ–‡ä»¶
                // å¢åŠ ç‰ˆæœ¬åç¼€é˜²æ­¢ Vercel ç¼“å­˜æ—§çš„æŸåæ–‡ä»¶
                const v = "?v=" + new Date().getTime();
                
                const wasmUrl = await fetchWithProgress('/ffmpeg-core.wasm' + v, 'å†…æ ¸');
                const coreUrl = await fetchWithProgress('/ffmpeg-core.js' + v, 'è°ƒåº¦å™¨');
                const workerUrl = await fetchWithProgress('/ffmpeg-core.worker.js' + v, 'å¹¶è¡Œæ’ä»¶');

                statusEl.innerText = "ğŸš€ æ­£åœ¨æŒ‚è½½å†…æ ¸...";
                log("æ­£åœ¨è°ƒç”¨ ffmpeg.load()...");

                await ffmpeg.load({
                    coreURL: coreUrl,
                    wasmURL: wasmUrl,
                    workerURL: workerUrl
                });

                progressContainer.style.display = 'none';
                statusEl.innerText = "âœ… ç³»ç»Ÿå°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶";
                btn.disabled = false;
                log("æ‰€æœ‰ç»„ä»¶æŒ‚è½½æˆåŠŸï¼");

            } catch (err) {
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                statusEl.style.color = "red";
                log("é”™è¯¯åŸå› : " + err.message);
                console.error(err);
            }
        }

        initSystem();
    </script>
</body>
</html>