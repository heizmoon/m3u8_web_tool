<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - æé€Ÿè§£å¯†åˆå¹¶å·¥å…·</title>
    <style>
        :root { --primary: #0070f3; --bg: #f5f7fa; }
        body { font-family: "Segoe UI", system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; display: grid; grid-template-columns: 1fr 250px; gap: 20px; }
        .main-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .init-box { margin: 20px 0; padding: 15px; background: #f0f4ff; border-radius: 8px; }
        .progress-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 12px; margin: 10px 0; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; }
        
        /* æ“ä½œè¯´æ˜åŒº */
        .info-card { background: #fffbe6; border: 1px solid #ffe58f; padding: 15px; border-radius: 8px; font-size: 13px; line-height: 1.6; }
        .info-card h4 { margin-top: 0; color: #856404; }

        /* å¹¿å‘Šå ä½ç¬¦ */
        .ad-slot { background: #eee; border: 2px dashed #ccc; height: 250px; display: flex; align-items: center; justify-content: center; color: #999; border-radius: 8px; font-size: 12px; }

        #log { background: #1a1a1a; color: #00ff00; padding: 15px; height: 200px; overflow-y: auto; font-size: 11px; border-radius: 6px; font-family: monospace; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status-text { font-weight: bold; font-size: 14px; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h3>ğŸ¬ M3U8 æé€Ÿåˆå¹¶åŠ©æ‰‹</h3>
        
        <div class="init-box" id="initUI">
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span id="initTask">æ­£åœ¨å‡†å¤‡å¼•å¯¼ç¨‹åº...</span>
                <span id="initPercent">0%</span>
            </div>
            <div class="progress-container">
                <div id="initBar" class="progress-bar"></div>
            </div>
            <div id="threadStatus" style="font-size: 11px; color: #666;">çº¿ç¨‹æ¢æµ‹ä¸­...</div>
        </div>

        <button id="runBtn" class="btn" onclick="startProcess()" disabled>æ­£åœ¨åˆå§‹åŒ–å¼•æ“...</button>
        
        <div id="status" style="margin: 15px 0; min-height: 20px;"></div>
        <div id="log"></div>
    </div>

    <div class="sidebar">
        <div class="info-card">
            <h4>ğŸ’¡ ä½¿ç”¨è¦ç‚¹</h4>
            <ul style="padding-left: 18px; margin: 0;">
                <li><b>æ–‡ä»¶ç»“æ„ï¼š</b>ç¡®ä¿æ–‡ä»¶å¤¹å†…åŒ…å« index.m3u8 åŠ index/ å­ç›®å½•ã€‚</li>
                <li><b>å†…å­˜é™åˆ¶ï¼š</b>è‹¥ TS ç‰‡æ®µè¶…è¿‡ 2000 ä¸ªï¼Œå»ºè®®åˆ†æ‰¹å¤„ç†é˜²æ­¢æµè§ˆå™¨å´©æºƒã€‚</li>
                <li><b>è§£å¯†ï¼š</b>ç¨‹åºä¼šè‡ªåŠ¨å¯»æ‰¾ 0.key è¿›è¡Œ AES-128 è§£å¯†ã€‚</li>
                <li><b>ä¸è¦å…³é—­ï¼š</b>åˆå¹¶å¤§æ–‡ä»¶æ—¶ï¼Œè¯·ä¿æŒæœ¬é¡µé¢å¤„äºæœ€å‰ç«¯ã€‚</li>
            </ul>
        </div>

        <div class="ad-slot">
            <div style="text-align: center;">
                <p>å•†ä¸šå¹¿å‘Šä½</p>
                <p style="font-size: 10px;">ADVERTISING SLOT</p>
            </div>
        </div>
    </div>
</div>

<script>
    const logEl = document.getElementById('log');
    const initTask = document.getElementById('initTask');
    const initPercent = document.getElementById('initPercent');
    const initBar = document.getElementById('initBar');
    const threadStatus = document.getElementById('threadStatus');
    const btn = document.getElementById('runBtn');
    
    const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
    
    let ffmpeg = null;
    const WASM_SIZE = 37.1 * 1024 * 1024; // 37.1 MB

    // 1. å¸¦è¿›åº¦çš„æ–‡ä»¶åŠ è½½
    async function fetchWithProgress(url, taskName) {
        const response = await fetch(url);
        const reader = response.body.getReader();
        const contentLength = +response.headers.get('Content-Length') || WASM_SIZE;
        let receivedLength = 0;
        let chunks = [];

        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            receivedLength += value.length;
            let percent = Math.min(Math.round((receivedLength / contentLength) * 100), 100);
            
            initTask.innerText = `æ­£åœ¨åŠ è½½ ${taskName}...`;
            initPercent.innerText = `${percent}%`;
            initBar.style.width = `${percent}%`;
        }
        
        const blob = new Blob(chunks);
        return URL.createObjectURL(blob);
    }

    async function initSystem() {
        try {
            // ç¬¬ä¸€æ­¥ï¼šåŠ è½½ä¸»è„šæœ¬
            const script = document.createElement('script');
            script.src = '/ffmpeg.js'; //
            document.head.appendChild(script);
            await new Promise(r => script.onload = r);

            const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
            ffmpeg = new FFmpeg();

            // ç¬¬äºŒæ­¥ï¼šä¸‹è½½æ ¸å¿ƒç»„ä»¶å¹¶æ˜¾ç¤ºè¿›åº¦
            const wasmURL = await fetchWithProgress('/ffmpeg-core.wasm', 'WASM å†…æ ¸');
            const coreURL = await fetchWithProgress('/ffmpeg-core.js', 'æ ¸å¿ƒè°ƒåº¦å™¨');
            const workerURL = await fetchWithProgress('/ffmpeg-core.worker.js', 'å¤šçº¿ç¨‹æ’ä»¶');

            // ç¬¬ä¸‰æ­¥ï¼šå¤šçº¿ç¨‹åˆå§‹åŒ–è¿›åº¦
            initTask.innerText = "æ­£åœ¨æ¿€æ´»å¤šçº¿ç¨‹å¹¶è¡Œè§£å¯†...";
            const hardwareThreads = navigator.hardwareConcurrency || 4;
            threadStatus.innerText = `æ£€æµ‹åˆ°ç³»ç»Ÿ CPU æ ¸å¿ƒæ•°: ${hardwareThreads}`;
            
            await ffmpeg.load({ coreURL, wasmURL, workerURL });

            // å®Œæˆåˆå§‹åŒ–
            document.getElementById('initUI').style.background = "#e6ffed";
            initTask.innerText = "âœ… å¼•æ“åˆå§‹åŒ–åœ†æ»¡å®Œæˆ";
            initBar.style.background = "#52c41a";
            btn.disabled = false;
            btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶è§†é¢‘";
            log("ç³»ç»Ÿå·²å°±ç»ªï¼Œå¤šçº¿ç¨‹å·²å°±ç»ªã€‚");

            // ç›‘å¬åˆå¹¶æ—¥å¿—
            ffmpeg.on('log', ({ message }) => {
                if(message.includes('frame=')) {
                    document.getElementById('status').innerText = "ğŸš€ æ­£åœ¨å¤„ç†æ•°æ®æµ: " + message;
                }
                log(`[å†…æ ¸] ${message}`);
            });

        } catch (err) {
            initTask.innerText = "âŒ åˆå§‹åŒ–å¤±è´¥: " + err.message;
            initBar.style.background = "#ff4d4f";
        }
    }

    async function startProcess() {
        try {
            const dirHandle = await window.showDirectoryPicker();
            btn.disabled = true;
            log(`å·²é€‰æ‹©ç›®å½•: ${dirHandle.name}`);

            // æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿç»“æ„
            try { await ffmpeg.createDir('index'); } catch(e) {}

            let m3u8Content = "";
            let tsList = [];

            for await (const entry of dirHandle.values()) {
                if (entry.name === 'index.m3u8') {
                    m3u8Content = await (await entry.getFile()).text();
                } else if (entry.name === 'index' && entry.kind === 'directory') {
                    for await (const sub of entry.values()) tsList.push(sub);
                }
            }

            // æ‰¹é‡å†™å…¥
            for (let i = 0; i < tsList.length; i++) {
                const file = await tsList[i].getFile();
                await ffmpeg.writeFile(`index/${tsList[i].name}`, new Uint8Array(await file.arrayBuffer()));
                if(i % 100 === 0) document.getElementById('status').innerText = `ğŸ“¥ è½½å…¥æ–‡ä»¶: ${i}/${tsList.length}`;
            }

            m3u8Content = m3u8Content.replace(/URI="([^"]+)"/g, (m, p1) => `URI="index/${p1.split('/').pop()}"`);
            await ffmpeg.writeFile('index.m3u8', m3u8Content);

            log("å¼€å§‹è§£å¯†åˆå¹¶...");
            await ffmpeg.exec([
                '-allowed_extensions', 'ALL',
                '-i', 'index.m3u8',
                '-c', 'copy',
                '-fflags', '+genpts', // è§£å†³æ—¶é—´æˆ³æ­»é”
                'output.mp4'
            ]);

            const data = await ffmpeg.readFile('output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            const a = document.createElement('a');
            a.href = url;
            a.download = dirHandle.name + ".mp4";
            a.click();

            document.getElementById('status').innerText = "ğŸ‰ è§†é¢‘åˆå¹¶å·²å®Œæˆï¼";
            btn.disabled = false;
        } catch (e) {
            log("æ“ä½œå¤±è´¥: " + e.message);
            btn.disabled = false;
        }
    }

    initSystem();
</script>

</body>
</html>