<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - æŒ‰é’®ä¿®å¤å¢å¼ºç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 500px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 250px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status-msg { margin: 10px 0; font-weight: bold; color: #d946ef; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹ (æœ€ç»ˆä¿®å¤ç‰ˆ)</h3>
        <div id="status" class="status-msg">æ­£åœ¨å‡†å¤‡å¼•æ“ï¼Œè¯·ç¨å€™...</div>
        <button id="runBtn" class="btn" onclick="startProcess()">é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶è§†é¢‘</button>
        <div id="log">æ­£åœ¨åŠ è½½æ ¸å¿ƒç»„ä»¶...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
        
        let ffmpeg = null;
        let isReady = false;

        async function initSystem() {
            try {
                btn.disabled = true;
                log("1. åŠ è½½è„šæœ¬ç»„ä»¶...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.js'; // ç¡®ä¿æ­¤æ–‡ä»¶å·²é‡å‘½å
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
                ffmpeg = new FFmpeg();

                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('frame=')) {
                        statusEl.innerText = "ğŸš€ æ­£åœ¨æ‹¼åˆ: " + message.split('fps=')[0];
                    }
                    log(`[å†…æ ¸] ${message}`);
                });

                // ä¸ºäº†ç»å¯¹çš„ç¨³å®šæ€§ï¼Œå…ˆä½¿ç”¨æœ€åŸºç¡€çš„åŠ è½½æ–¹å¼
                log("2. æ¿€æ´» WASM å†…æ ¸...");
                await ffmpeg.load({
                    coreURL: '/ffmpeg-core.js',
                    wasmURL: '/ffmpeg-core.wasm'
                    // å¦‚æœå¤šçº¿ç¨‹æ€»å´©ï¼Œè¿™é‡Œæš‚æ—¶ä¸ä¼  workerURL å°è¯•å•çº¿ç¨‹æµå¼
                });

                isReady = true;
                btn.disabled = false;
                statusEl.innerText = "âœ… ç³»ç»Ÿå·²å°±ç»ªï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®";
                statusEl.style.color = "green";
                log("3. åˆå§‹åŒ–åœ†æ»¡å®Œæˆã€‚");
            } catch (err) {
                log("åˆå§‹åŒ–å¤±è´¥: " + err.message);
                statusEl.innerText = "âŒ å¼•æ“å¯åŠ¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢";
            }
        }

        async function startProcess() {
            if (!isReady) {
                alert("å¼•æ“å°šæœªå°±ç»ªï¼Œè¯·ç¨ç­‰å‡ ç§’...");
                return;
            }

            try {
                // è°ƒç”¨åŸç”Ÿ API é€‰æ‹©æ–‡ä»¶å¤¹
                const dirHandle = await window.showDirectoryPicker();
                btn.disabled = true;
                statusEl.innerText = "ğŸ“‚ æ­£åœ¨æ‰«ææ–‡ä»¶...";
                log(`é”å®šç›®å½•: ${dirHandle.name}`);

                try { await ffmpeg.createDir('index'); } catch(e) {}

                let m3u8Content = "";
                let filesToLoad = [];

                // éå†è·å–å¥æŸ„
                for await (const entry of dirHandle.values()) {
                    if (entry.name === 'index.m3u8') {
                        const file = await entry.getFile();
                        m3u8Content = await file.text();
                    } else if (entry.kind === 'directory' && entry.name === 'index') {
                        for await (const subEntry of entry.values()) {
                            filesToLoad.push(subEntry);
                        }
                    }
                }

                if (!m3u8Content) throw new Error("æœªæ‰¾åˆ° index.m3u8");

                // åˆ†æ‰¹è½½å…¥ï¼Œå‡å°‘å†…å­˜å‹åŠ›
                log(`å‘ç° ${filesToLoad.length} ä¸ªç‰‡æ®µï¼Œå¼€å§‹è½½å…¥è™šæ‹Ÿå†…å­˜...`);
                for (let i = 0; i < filesToLoad.length; i++) {
                    const file = await filesToLoad[i].getFile();
                    const data = new Uint8Array(await file.arrayBuffer());
                    await ffmpeg.writeFile(`index/${filesToLoad[i].name}`, data);
                    if (i % 200 === 0) statusEl.innerText = `ğŸ“¥ è½½å…¥è¿›åº¦: ${i}/${filesToLoad.length}`;
                }

                // è·¯å¾„é€‚é…
                m3u8Content = m3u8Content.replace(/URI="([^"]+)"/g, (m, p1) => `URI="index/${p1.split('/').pop()}"`);
                await ffmpeg.writeFile('index.m3u8', m3u8Content);

                log("å¼€å§‹æ‰§è¡Œ FFmpeg æŒ‡ä»¤...");
                // å…³é”®ä¼˜åŒ–ï¼š-fflags +genpts è§£å†³ 2292.ts åçš„æ­»é”é—®é¢˜
                await ffmpeg.exec([
                    '-allowed_extensions', 'ALL',
                    '-i', 'index.m3u8',
                    '-c', 'copy',
                    '-fflags', '+genpts',
                    'output.mp4'
                ]);

                log("åˆå¹¶å®Œæˆï¼Œå‡†å¤‡ä¸‹è½½...");
                const result = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = dirHandle.name + ".mp4";
                a.click();

                statusEl.innerText = "ğŸ‰ å¯¼å‡ºæˆåŠŸï¼";
                btn.disabled = false;
            } catch (e) {
                log("æ‰§è¡Œä¸­æ–­: " + e.message);
                btn.disabled = false;
                statusEl.innerText = "âŒ æ“ä½œå¤±è´¥";
            }
        }

        // å¯åŠ¨
        initSystem();
    </script>
</body>
</html>