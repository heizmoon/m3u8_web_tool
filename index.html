<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - ç¨³å®šåˆ†æ®µç‰ˆ</title>
    <style>
        :root { --primary: #0070f3; --success: #22c55e; }
        body { font-family: system-ui; background: #f4f7f6; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 800px; margin: 0 auto; }
        #log { background: #0f172a; color: #38bdf8; padding: 15px; height: 200px; overflow-y: auto; font-size: 11px; border-radius: 8px; margin-top: 15px; font-family: monospace; }
        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        .btn:disabled { background: #cbd5e1; }
        .progress-box { margin-bottom: 20px; }
        .bar-container { width: 100%; background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¬ M3U8 åˆå¹¶ (è¶…é•¿è§†é¢‘ç¨³å®šç‰ˆ)</h2>
    
    <div class="progress-box">
        <div style="display:flex; justify-content:space-between; font-size:12px;">
            <span id="task-name">ç­‰å¾…åˆå§‹åŒ–...</span>
            <b id="task-pct">0%</b>
        </div>
        <div class="bar-container"><div id="task-bar" class="bar"></div></div>
    </div>

    <button id="runBtn" class="btn" onclick="startProcess()" disabled>å¼•æ“è½½å…¥ä¸­...</button>

    <div id="status-panel" style="display:none; margin-top:15px;">
        <div id="main-msg" style="font-weight:bold; color:var(--primary); margin-bottom:10px;"></div>
        <div class="stats-grid">
            <div style="font-size:13px;">æ—¶é•¿: <b id="stat-time">-</b></div>
            <div style="font-size:13px;">ä½“ç§¯: <b id="stat-size">-</b></div>
            <div style="font-size:13px;">é€Ÿåº¦: <b id="stat-speed">-</b></div>
            <div style="font-size:13px;">è¿›åº¦: <b id="stat-part">-</b></div>
        </div>
    </div>

    <div id="log"></div>
</div>

<script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('runBtn');
    const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
    
    let ffmpeg = null;

    async function initSystem() {
        try {
            const script = document.createElement('script');
            script.src = '/ffmpeg.js';
            document.head.appendChild(script);
            await new Promise(r => script.onload = r);

            const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
            ffmpeg = new FFmpeg();

            ffmpeg.on('log', ({ message }) => {
                if (message.includes('frame=')) parseLog(message);
                log(`[å†…æ ¸] ${message}`);
            });

            // è¿›åº¦ä¿®æ­£ï¼šä½¿ç”¨æ›´ä¿å®ˆçš„é¢„ä¼°å€¼
            const wasmURL = await fetchP('/ffmpeg-core.wasm', 'æ ¸å¿ƒå†…æ ¸', 32000000); 
            const coreURL = await fetchP('/ffmpeg-core.js', 'è°ƒåº¦å™¨', 100000);
            const workerURL = await fetchP('/ffmpeg-core.worker.js', 'å¤šçº¿ç¨‹', 100000);

            await ffmpeg.load({ coreURL, wasmURL, workerURL });
            document.getElementById('task-name').innerText = "âœ… å¼•æ“å‡†å¤‡å°±ç»ª";
            document.getElementById('task-bar').style.background = "var(--success)";
            btn.disabled = false;
        } catch (e) { log("åˆå§‹åŒ–å¤±è´¥: " + e.message); }
    }

    async function fetchP(url, name, estSize) {
        const resp = await fetch(url);
        const reader = resp.body.getReader();
        const total = +resp.headers.get('Content-Length') || estSize;
        let loaded = 0;
        let chunks = [];
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.length;
            // ä¿®æ­£ç™¾åˆ†æ¯”ç®—æ³•ï¼šé˜²æ­¢è¶…è¿‡ 100%
            const pct = Math.min(Math.round((loaded / total) * 100), 99); 
            document.getElementById('task-name').innerText = `è½½å…¥ ${name}...`;
            document.getElementById('task-pct').innerText = pct + '%';
            document.getElementById('task-bar').style.width = pct + '%';
        }
        document.getElementById('task-pct').innerText = '100%';
        document.getElementById('task-bar').style.width = '100%';
        return URL.createObjectURL(new Blob(chunks));
    }

    function parseLog(msg) {
        document.getElementById('status-panel').style.display = 'block';
        const time = msg.match(/time=\s*([\d:.]+)/)?.[1] || '-';
        const size = msg.match(/size=\s*(\d+)kB/)?.[1] || '0';
        let speed = msg.match(/speed=\s*([\d.e+x\s]+)/)?.[1] || '-';
        
        // ç§‘å­¦è®¡æ•°æ³•ä¿®å¤
        if (speed.includes('e+')) speed = Math.round(parseFloat(speed)) + 'x';

        document.getElementById('stat-time').innerText = time;
        document.getElementById('stat-size').innerText = (parseInt(size)/1024).toFixed(1) + ' MB';
        document.getElementById('stat-speed').innerText = speed;
    }

    async function startProcess() {
        try {
            const dir = await window.showDirectoryPicker();
            btn.disabled = true;
            log(`å·²é”å®š: ${dir.name}`);

            try { await ffmpeg.createDir('index'); } catch(e){}

            let m3u8 = "";
            let ts = [];
            for await (const e of dir.values()) {
                if (e.name === 'index.m3u8') m3u8 = await (await e.getFile()).text();
                else if (e.name === 'index') {
                    for await (const s of e.values()) {
                        if(s.name.endsWith('.ts')) ts.push(s);
                        if(s.name.endsWith('.key')) await ffmpeg.writeFile(`index/${s.name}`, new Uint8Array(await (await s.getFile()).arrayBuffer()));
                    }
                }
            }
            ts.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));

            // åˆ†æ®µé€»è¾‘ï¼š800ä¸ªä¸€ç»„ï¼Œç¡®ä¿å•æ–‡ä»¶ç»ä¸è¶… 1.5GB
            const bSize = 800; 
            const parts = [];
            for (let i = 0; i < ts.length; i += bSize) parts.push(ts.slice(i, i + bSize));

            log(`æ£€æµ‹åˆ° ${ts.length} ä¸ªç‰‡æ®µï¼Œä¸ºä¿ç¨³å®šå°†åˆ† ${parts.length} æ®µå¯¼å‡ºã€‚`);

            for (let i = 0; i < parts.length; i++) {
                const name = `Part_${i+1}.mp4`;
                document.getElementById('main-msg').innerText = `ğŸš€ æ­£åœ¨ç”Ÿæˆç¬¬ ${i+1}/${parts.length} æ®µ...`;
                document.getElementById('stat-part').innerText = `${i+1} / ${parts.length}`;
                
                await processBatch(parts[i], m3u8, name);
                
                // ç«‹å³ä¸‹è½½å½“å‰åˆ†æ®µï¼Œé‡Šæ”¾ WASM å†…å­˜
                const data = await ffmpeg.readFile(name);
                download(data, `${dir.name}_${name}`);
                await ffmpeg.deleteFile(name);

                // æ¸…ç† TS ç¼“å­˜
                for(const f of parts[i]) try { await ffmpeg.deleteFile(`index/${f.name}`); } catch(e){}
                log(`æ®µè½ ${i+1} å·²å®Œæˆå¹¶é‡Šæ”¾å†…å­˜ã€‚`);
            }

            document.getElementById('main-msg').innerText = "ğŸ‰ æ‰€æœ‰åˆ†æ®µå·²ä¸‹è½½å®Œæˆï¼";
            alert("ç”±äºè§†é¢‘è¿‡å¤§ï¼Œå·²åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ä¸‹è½½ä»¥é˜²å´©æºƒã€‚æ‚¨å¯ä»¥å°†å®ƒä»¬ç›´æ¥æ‹–å…¥å‰ªè¾‘è½¯ä»¶æˆ–æ’­æ”¾å™¨è§‚çœ‹ã€‚");
            btn.disabled = false;
        } catch (e) { log("å¤±è´¥: " + e.message); btn.disabled = false; }
    }

    async function processBatch(list, m3u8, out) {
        for (const f of list) await ffmpeg.writeFile(`index/${f.name}`, new Uint8Array(await (await f.getFile()).arrayBuffer()));
        
        const set = new Set(list.map(f => f.name));
        const newM = m3u8.split('\n').filter(l => l.includes('.ts') ? set.has(l.trim().split('/').pop()) : true).join('\n')
                      .replace(/URI="([^"]+)"/g, (m, p) => `URI="index/${p.split('/').pop()}"`);

        await ffmpeg.writeFile('t.m3u8', new TextEncoder().encode(newM));
        await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 't.m3u8', '-c', 'copy', '-fflags', '+genpts', out]);
        await ffmpeg.deleteFile('t.m3u8');
    }

    function download(data, name) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
        a.download = name;
        a.click();
    }

    initSystem();
</script>
</body>
</html>