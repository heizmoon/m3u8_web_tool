<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 å•†ä¸šåŒ–åˆå¹¶å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/index.min.js"></script>
    <style>
        body { font-family: system-ui; background: #fafafa; display: flex; justify-content: center; padding: 50px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 500px; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 7px; width: 100%; cursor: pointer; font-size: 16px; }
        #log { background: #000; color: #0f0; padding: 10px; height: 150px; overflow: auto; margin-top: 20px; font-size: 12px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 åˆå¹¶å™¨</h2>
        <button id="btn" class="btn">é€‰æ‹©æ–‡ä»¶å¤¹å¼€å§‹</button>
        <div id="log">ç­‰å¾…å†…æ ¸åŠ è½½...</div>
        <div id="out" style="display:none; margin-top:20px; text-align:center;">
            <a id="dl" href="#" style="color:#0070f3; font-weight:bold;">âœ… åˆå¹¶å®Œæˆï¼Œç‚¹å‡»ä¸‹è½½ MP4</a>
        </div>
    </div>

    <script>
        // å…³é”®ä¿®å¤ï¼šVercel éƒ¨ç½²ç¯å¢ƒä¸‹çš„å˜é‡å¼•ç”¨
        const { FFmpeg } = FFmpegWASM || {}; 
        const ffmpeg = new FFmpeg();

        const log = (m) => { document.getElementById('log').innerText += `\n> ${m}`; };

        async function init() {
            try {
                await ffmpeg.load({
                    coreURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js',
                });
                log("å†…æ ¸åŠ è½½æˆåŠŸï¼");
            } catch (e) { log("åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°æˆ–æ›´æ¢æµè§ˆå™¨"); }
        }

        document.getElementById('btn').onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                log("è·å–æ–‡ä»¶å¤¹æˆåŠŸ");
                
                // è¯»å– index.m3u8 å¹¶å¤„ç† index ç›®å½•
                const m3u8H = await handle.getFileHandle('index.m3u8');
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(await (await m3u8H.getFile()).arrayBuffer()));
                
                await ffmpeg.createDir('index');
                const idxDir = await handle.getDirectoryHandle('index');
                for await (const entry of idxDir.values()) {
                    if (entry.kind === 'file') {
                        const data = new Uint8Array(await (await entry.getFile()).arrayBuffer());
                        await ffmpeg.writeFile(`index/${entry.name}`, data);
                        log(`è½½å…¥: ${entry.name}`);
                    }
                }

                log("æ­£åœ¨è§£å¯†åˆå¹¶...");
                await ffmpeg.exec(['-i', 'index.m3u8', '-c', 'copy', 'out.mp4']);
                
                const data = await ffmpeg.readFile('out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], {type: 'video/mp4'}));
                document.getElementById('dl').href = url;
                document.getElementById('dl').download = "video.mp4";
                document.getElementById('out').style.display = 'block';
                log("å®Œæˆï¼");
            } catch (e) { log("æ“ä½œå–æ¶ˆæˆ–å‡ºé”™: " + e.message); }
        };
        init();
    </script>
</body>
</html>