<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - å†…å­˜ä¼˜åŒ–æµå¼ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 90%; max-width: 600px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 300px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: wait; }
        .status-bar { margin: 10px 0; padding: 10px; border-radius: 6px; background: #eef2ff; color: #3730a3; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 æé€Ÿåˆå¹¶ (å†…å­˜ä¼˜åŒ–ç‰ˆ)</h3>
        <div id="status" class="status-bar">æ­£åœ¨åŠ è½½å¤šçº¿ç¨‹å¼•æ“...</div>
        <button id="runBtn" class="btn" disabled>å¼•æ“åˆå§‹åŒ–ä¸­...</button>
        <div id="log">ç­‰å¾…å†…æ ¸è½½å…¥...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };
        let ffmpeg = null;

        async function initSystem() {
            try {
                const script = document.createElement('script');
                script.src = '/ffmpeg.js'; // ç¡®ä¿æ–‡ä»¶åæ­£ç¡®
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const { FFmpeg } = window.FFmpegWASM || window.FFmpeg;
                ffmpeg = new FFmpeg();

                // æ ¸å¿ƒï¼šç›‘æ§å†…å­˜å‹åŠ›ï¼Œå®æ—¶åé¦ˆè¿›åº¦
                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('Opening')) {
                        const file = message.split("'")[1];
                        statusEl.innerText = `ğŸ”“ æ­£åœ¨è§£å¯†: ${file}`;
                    }
                    log(`[FFmpeg] ${message}`);
                });

                await ffmpeg.load({
                    coreURL: '/ffmpeg-core.js',
                    wasmURL: '/ffmpeg-core.wasm',
                    workerURL: '/ffmpeg-core.worker.js' // å¯ç”¨å¤šçº¿ç¨‹åˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›
                });

                statusEl.innerText = "âœ… ç³»ç»Ÿå°±ç»ª";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹å¼€å§‹åˆå¹¶";
                btn.disabled = false;
                log("åˆå§‹åŒ–æˆåŠŸã€‚è¯·ç¡®ä¿æµè§ˆå™¨å†…å­˜å……è¶³ã€‚");
            } catch (err) {
                statusEl.innerText = "âŒ åŠ è½½å¤±è´¥";
                log("å¯åŠ¨é”™è¯¯: " + err.message);
            }
        }

        async function startProcess() {
            try {
                const rootHandle = await window.showDirectoryPicker();
                btn.disabled = true;
                statusEl.innerText = "ğŸ“‚ æ­£åœ¨åˆ†æç›®å½•ç»“æ„...";

                // åˆ›å»ºè™šæ‹Ÿç›®å½•
                try { await ffmpeg.createDir('index'); } catch(e) {}

                let m3u8Content = "";
                let tsEntries = [];

                // 1. æ‰«ææ–‡ä»¶å¥æŸ„è€Œä¸ç«‹å³è¯»å–æ•°æ®ï¼ˆèŠ‚çœåˆå§‹å†…å­˜ï¼‰
                for await (const entry of rootHandle.values()) {
                    if (entry.name === 'index.m3u8') {
                        m3u8Content = await (await entry.getFile()).text();
                    } else if (entry.kind === 'directory' && entry.name === 'index') {
                        for await (const sub of entry.values()) {
                            tsEntries.push(sub);
                        }
                    }
                }

                // 2. åˆ†æ‰¹è½½å…¥ï¼šæ¯æ‰¹ 100 ä¸ªæ–‡ä»¶ï¼Œé™ä½ JS å †å†…å­˜ç¬æ—¶å‹åŠ›
                log(`å‘ç° ${tsEntries.length} ä¸ªæ–‡ä»¶ï¼Œå¼€å§‹åˆ†æ‰¹è£…è½½...`);
                for (let i = 0; i < tsEntries.length; i++) {
                    const file = await tsEntries[i].getFile();
                    const data = new Uint8Array(await file.arrayBuffer());
                    await ffmpeg.writeFile(`index/${tsEntries[i].name}`, data);
                    
                    if (i % 200 === 0) {
                        statusEl.innerText = `ğŸ“¥ è½½å…¥è¿›åº¦: ${i}/${tsEntries.length}`;
                        log(`å·²è½½å…¥ ${i} ä¸ªç‰‡æ®µ...`);
                    }
                }

                // 3. ä¿®å¤ M3U8 ä¸­çš„è·¯å¾„å¼•ç”¨
                m3u8Content = m3u8Content.replace(/URI="([^"]+)"/g, (m, p1) => `URI="index/${p1.split('/').pop()}"`);
                await ffmpeg.writeFile('index.m3u8', m3u8Content);

                // 4. æ‰§è¡Œåˆå¹¶æŒ‡ä»¤ï¼šåŠ å…¥ä¼˜åŒ–å‚æ•°é˜²æ­¢å¡æ­»
                log("å¼€å§‹æ‰§è¡Œåˆå¹¶ï¼ˆæ­¤è¿‡ç¨‹è€—æ—¶è¾ƒé•¿ï¼Œè¯·å‹¿åˆ‡æ¢æ ‡ç­¾é¡µï¼‰...");
                await ffmpeg.exec([
                    '-allowed_extensions', 'ALL',
                    '-i', 'index.m3u8',
                    '-c', 'copy',          // æ— æŸåˆå¹¶ï¼Œæœ€å¿«é€Ÿåº¦
                    '-bsf:a', 'aac_adtstoasc',
                    '-fflags', '+genpts',  // å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ—¶é—´æˆ³ï¼Œè§£å†³ 2292.ts åçš„å‡æ­»
                    'output.mp4'
                ]);

                // 5. å¯¼å‡ºç»“æœ
                statusEl.innerText = "ğŸ’¾ æ­£åœ¨æå–è§†é¢‘...";
                const resultData = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([resultData.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = `${rootHandle.name}_merged.mp4`;
                a.click();

                statusEl.innerText = "ğŸ‰ åˆå¹¶æˆåŠŸï¼";
                btn.disabled = false;
            } catch (e) {
                log("é”™è¯¯: " + e.message);
                btn.disabled = false;
                statusEl.innerText = "âŒ åˆå¹¶ä¸­æ–­";
            }
        }

        initSystem();
    </script>
</body>
</html>