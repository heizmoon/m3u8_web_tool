<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 æœ¬åœ°æé€Ÿåˆå¹¶</title>
    <script src="ffmpeg.min.js"></script>
    <style>
        body { font-family: system-ui; background: #f9fafb; display: flex; justify-content: center; padding: 40px; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 450px; text-align: center; }
        .btn { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; }
        #log { background: #111827; color: #10b981; padding: 15px; height: 160px; overflow-y: auto; margin-top: 20px; border-radius: 6px; font-family: monospace; font-size: 12px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ¬ M3U8 å·¥å…·ç®±</h2>
        <button id="runBtn" class="btn">é€‰æ‹©æ–‡ä»¶å¤¹å¹¶åˆå¹¶</button>
        <div id="log">ç­‰å¾…åˆå§‹åŒ–...</div>
    </div>

    <script>
        // å…³é”®ï¼šç°åœ¨çš„ç‰ˆæœ¬ç›´æ¥é€šè¿‡ FFmpegWASM è®¿é—®
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();

        const log = (msg) => {
            const el = document.getElementById('log');
            el.innerText += `\n> ${msg}`;
            el.scrollTop = el.scrollHeight;
        };

        async function init() {
            try {
                // æŒ‡å‘æœ¬åœ°ä»“åº“ä¸­çš„æ–‡ä»¶
                await ffmpeg.load({
                    coreURL: window.location.origin + '/ffmpeg-core.js',
                    wasmURL: window.location.origin + '/ffmpeg-core.wasm',
                    workerURL: window.location.origin + '/ffmpeg-core.worker.js'
                });
                log("å†…æ ¸åŠ è½½æˆåŠŸï¼å·²è„±ç¦» CDN è¿è¡Œã€‚");
            } catch (e) {
                log("åˆå§‹åŒ–å¤±è´¥ã€‚è¯·æ£€æŸ¥æ˜¯å¦ä¸Šä¼ äº† vercel.json ä¸”æµè§ˆå™¨æ”¯æŒ WebAssemblyã€‚");
            }
        }

        document.getElementById('runBtn').onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                log("å·²è·å–æ–‡ä»¶å¤¹æƒé™");

                // 1. å†™å…¥ä¸» index.m3u8
                const m3u8Handle = await handle.getFileHandle('index.m3u8');
                const m3u8Data = await (await m3u8Handle.getFile()).arrayBuffer();
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(m3u8Data));

                // 2. è‡ªåŠ¨é€’å½’è¯»å– index ç›®å½•ä¸‹çš„æ‰€æœ‰åˆ†ç‰‡ (ts/key)
                await ffmpeg.createDir('index');
                const subDir = await handle.getDirectoryHandle('index');
                for await (const entry of subDir.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        const data = await file.arrayBuffer();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(data));
                        log(`è½½å…¥åˆ†ç‰‡: index/${entry.name}`);
                    }
                }

                log("ğŸš€ å¼€å§‹æ‰§è¡Œåˆå¹¶å‘½ä»¤...");
                // æ‰§è¡Œæ ‡å‡† FFmpeg åˆå¹¶å‘½ä»¤
                await ffmpeg.exec(['-i', 'index.m3u8', '-c', 'copy', 'output.mp4']);
                
                log("âœ… åˆå¹¶å®Œæˆï¼æ­£åœ¨å‡†å¤‡ä¸‹è½½...");
                const result = await ffmpeg.readFile('output.mp4');
                const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = "combined_video.mp4";
                a.click();
                log("æ–‡ä»¶å·²ä¸‹å‘ã€‚");
            } catch (err) {
                log("é”™è¯¯: " + err.message);
            }
        };

        init();
    </script>
</body>
</html>