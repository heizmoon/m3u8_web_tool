<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>M3U8 Pro - ç¨³å®šå…¼å®¹ç‰ˆ</title>
    <style>
        body { font-family: system-ui; text-align: center; padding: 40px; background: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block; width: 460px; }
        #log { background: #111; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; text-align: left; font-size: 11px; margin-top: 20px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .btn { background: #0070f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #ccc; }
        .progress-container { width: 100%; background: #eee; border-radius: 5px; margin-top: 15px; height: 16px; position: relative; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #0070f3; transition: width 0.1s; }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 16px; color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h3>ğŸ¬ M3U8 åˆå¹¶åŠ©æ‰‹ (å•çº¿ç¨‹ç¨³å®šç‰ˆ)</h3>
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #666;">åˆå§‹åŒ–ä¸­...</div>
        <div id="progressContainer" class="progress-container">
            <div id="progressText" class="progress-text">ç­‰å¾…ä¸‹è½½...</div>
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <button id="runBtn" class="btn" disabled>è¯·ç¨å€™...</button>
        <div id="log">æ­£åœ¨æ£€æµ‹ç³»ç»Ÿç»„ä»¶...</div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        const log = (m) => { logEl.innerText += `\n> ${m}`; logEl.scrollTop = logEl.scrollHeight; };

        // å¼ºåŠ›çš„æ‰‹åŠ¨ä¸‹è½½å™¨
        async function fetchWithProgress(url, name, expectedSize) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`ä¸‹è½½ ${name} å¤±è´¥: ${response.status}`);
            
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length') || expectedSize;
            let receivedLength = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                let percent = Math.min(Math.round((receivedLength / Math.max(contentLength, receivedLength)) * 100), 99);
                progressBar.style.width = percent + '%';
                progressText.innerText = `${percent}% (${(receivedLength/1024/1024).toFixed(1)}MB)`;
            }

            progressBar.style.width = '100%';
            progressText.innerText = '100%';
            const allChunks = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }
            return URL.createObjectURL(new Blob([allChunks.buffer], { type: url.includes('.js') ? 'text/javascript' : 'application/wasm' }));
        }

        async function initSystem() {
            try {
                log("1. åŠ è½½ä¸»è„šæœ¬...");
                const script = document.createElement('script');
                script.src = '/ffmpeg.js';
                document.head.appendChild(script);
                await new Promise(r => script.onload = r);

                const FF = window.FFmpegWASM || window.FFmpeg;
                const ffmpeg = new FF.FFmpeg();
                ffmpeg.on('log', ({ message }) => log(`[å†…æ ¸] ${message}`));

                // 2. å¼ºåˆ¶æ‰‹åŠ¨ä¸‹è½½å•çº¿ç¨‹å†…æ ¸ï¼ˆç¡®ä¿ä¸€å®šæœ‰ä¸‹è½½åŠ¨ä½œï¼‰
                const v = "?t=" + Date.now();
                log("2. å¼€å§‹ä¸‹è½½ WASM æ ¸å¿ƒ (å•çº¿ç¨‹ç‰ˆ)...");
                const wasmUrl = await fetchWithProgress('/ffmpeg-core.wasm' + v, 'å†…æ ¸', 31000000);
                
                log("3. å¼€å§‹ä¸‹è½½ è°ƒåº¦è„šæœ¬...");
                const coreUrl = await fetchWithProgress('/ffmpeg-core.js' + v, 'è°ƒåº¦è„šæœ¬', 100000);

                statusEl.innerText = "ğŸš€ æ­£åœ¨æŒ‚è½½å†…æ ¸...";
                log("4. æ­£åœ¨è°ƒç”¨ ffmpeg.load()...");

                // æ­¤æ—¶å·²ç»æ‹¿åˆ°äº† Blob URLï¼Œffmpeg.load ä¸å†éœ€è¦å‘èµ·ç½‘ç»œè¯·æ±‚
                await ffmpeg.load({
                    coreURL: coreUrl,
                    wasmURL: wasmUrl
                    // å•çº¿ç¨‹æ¨¡å¼ä¸ä¼  workerURL
                });

                statusEl.innerText = "âœ… ç³»ç»Ÿå°±ç»ª";
                statusEl.style.color = "green";
                btn.innerText = "é€‰æ‹©æ–‡ä»¶å¤¹åˆå¹¶";
                btn.disabled = false;
                log("5. å†…æ ¸åˆå§‹åŒ–æˆåŠŸï¼");

                btn.onclick = async () => {
                    try {
                        const handle = await window.showDirectoryPicker();
                        log("é€‰ä¸­æ–‡ä»¶å¤¹: " + handle.name);
                    } catch (e) { log("é”™è¯¯: " + e.message); }
                };

            } catch (err) {
                statusEl.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                log("é”™è¯¯è¯¦æƒ…: " + err.message);
                console.error(err);
            }
        }
        initSystem();
    </script>
</body>
</html>