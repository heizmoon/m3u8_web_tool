<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 Pro - æé€Ÿæœ¬åœ°è§†é¢‘åˆå¹¶</title>
    <script src="/ffmpeg.min.js"></script>
    <style>
        :root { --primary: #0070f3; --bg: #f5f7fa; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; margin: 0; }
        .card { background: white; padding: 32px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 480px; }
        h2 { margin: 0 0 10px 0; color: #111; font-size: 24px; }
        .status-pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; margin-bottom: 24px; background: #eee; color: #666; }
        .status-ready { background: #e6fffa; color: #059669; }
        .status-error { background: #fff5f5; color: #e53e3e; }
        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
        #log { background: #1a1a1a; color: #32d74b; padding: 16px; height: 160px; overflow-y: auto; margin-top: 24px; border-radius: 8px; font-family: "SF Mono", monospace; font-size: 11px; text-align: left; line-height: 1.6; border: 1px solid #333; }
        .progress-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 20px; display: none; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ¬ M3U8 è§†é¢‘åŠ©æ‰‹</h2>
        <div id="status" class="status-pill">æ­£åœ¨åˆå§‹åŒ–å†…æ ¸...</div>
        
        <button id="runBtn" class="btn" disabled>é€‰æ‹© M3U8 æ–‡ä»¶å¤¹åˆå¹¶</button>
        
        <div class="progress-container" id="progressWrap">
            <div id="progressBar"></div>
        </div>

        <div id="log">ç­‰å¾…æ“ä½œæ—¥å¿—...</div>

        <div style="margin-top: 20px; color: #999; font-size: 12px;">
            [å•†ä¸šæç¤º] çº¯æµè§ˆå™¨å¤„ç†ï¼Œä¸æ¶ˆè€—æµé‡ï¼Œéšç§å®‰å…¨ã€‚
        </div>
    </div>

    <script>
    // 1. å®Œå–„çš„åº“å¯¹è±¡è¯†åˆ«é€»è¾‘
    let FFmpegClass;
    
    // å»¶è¿Ÿåˆ°é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œï¼Œç¡®ä¿è„šæœ¬å·²è§£æ
    window.onload = async () => {
        const logEl = document.getElementById('log');
        const btn = document.getElementById('runBtn');
        const statusEl = document.getElementById('status');

        const addLog = (msg) => {
            logEl.innerText += `\n> ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        // è¯†åˆ«æ–°ç‰ˆ v0.12 çš„å…¨å±€å˜é‡å±‚çº§
        if (window.FFmpegWASM && window.FFmpegWASM.FFmpeg) {
            FFmpegClass = window.FFmpegWASM.FFmpeg;
        } else if (window.FFmpeg) {
            // å…¼å®¹æŸäº› UMD æ‰“åŒ…æ ¼å¼
            FFmpegClass = (typeof window.FFmpeg === 'function') 
                          ? window.FFmpeg 
                          : window.FFmpeg.FFmpeg;
        }

        if (!FFmpegClass) {
            statusEl.innerText = "âŒ æ— æ³•è¯†åˆ«åº“å¯¹è±¡";
            addLog("é”™è¯¯ï¼šè¯†åˆ«åˆ°è„šæœ¬ä½†æ— æ³•æ‰¾åˆ° FFmpeg æ„é€ å‡½æ•°ã€‚");
            return;
        }

        // 2. æ­£ç¡®å®ä¾‹åŒ–
        const ffmpeg = new FFmpegClass();
        addLog("åº“å¯¹è±¡è¯†åˆ«æˆåŠŸï¼Œæ­£åœ¨è½½å…¥å†…æ ¸...");

        async function init() {
            try {
                const baseURL = window.location.origin;
                await ffmpeg.load({
                    coreURL: `${baseURL}/ffmpeg-core.js`,
                    wasmURL: `${baseURL}/ffmpeg-core.wasm`,
                    workerURL: `${baseURL}/ffmpeg-core.worker.js`
                });
                
                statusEl.innerText = "â— å†…æ ¸å·²å°±ç»ª";
                statusEl.className = "status-pill status-ready";
                btn.disabled = false;
                addLog("åˆå§‹åŒ–æˆåŠŸï¼å¯ä»¥å¼€å§‹åˆå¹¶ã€‚");
            } catch (e) {
                statusEl.innerText = "â— åŠ è½½å¤±è´¥";
                addLog("é”™è¯¯: " + e.message);
            }
        }

        // 3. ç»‘å®šæŒ‰é’®äº‹ä»¶
        btn.onclick = async () => {
            try {
                const handle = await window.showDirectoryPicker();
                btn.disabled = true;
                addLog(`å¤„ç†ä¸­: ${handle.name}`);

                // è¯»å– index.m3u8
                const m3u8File = await (await handle.getFileHandle('index.m3u8')).getFile();
                await ffmpeg.writeFile('index.m3u8', new Uint8Array(await m3u8File.arrayBuffer()));

                // å†™å…¥ index ç›®å½•
                await ffmpeg.createDir('index');
                const subDir = await handle.getDirectoryHandle('index');
                for await (const entry of subDir.values()) {
                    if (entry.kind === 'file') {
                        const data = await (await entry.getFile()).arrayBuffer();
                        await ffmpeg.writeFile(`index/${entry.name}`, new Uint8Array(data));
                    }
                }

                addLog("æ‰§è¡Œåˆå¹¶æŒ‡ä»¤...");
                await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 'index.m3u8', '-c', 'copy', 'out.mp4']);

                const result = await ffmpeg.readFile('out.mp4');
                const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a');
                a.href = url;
                a.download = "merged.mp4";
                a.click();
                addLog("âœ… å®Œæˆï¼");
            } catch (err) {
                addLog("âŒ " + err.message);
            } finally {
                btn.disabled = false;
            }
        };

        init();
    };
</script>
</body>
</html>